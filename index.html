<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Escape the Underclass</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #050508;
    --surface: rgba(12, 12, 20, 0.7);
    --surface-solid: #0c0c14;
    --surface2: rgba(20, 20, 35, 0.6);
    --glass: rgba(255, 255, 255, 0.03);
    --glass-border: rgba(255, 255, 255, 0.06);
    --text: #e8e8f0;
    --text-dim: rgba(180, 180, 210, 0.6);
    --text-muted: rgba(140, 140, 170, 0.4);
    --accent: #00ffa3;
    --accent-glow: rgba(0, 255, 163, 0.15);
    --accent-dim: rgba(0, 255, 163, 0.4);
    --gold: #ffd000;
    --gold-glow: rgba(255, 208, 0, 0.15);
    --red: #ff3355;
    --blue: #3388ff;
    --purple: #8855ff;
    --purple-glow: rgba(136, 85, 255, 0.2);
    --neon-pink: #ff2288;
    --neon-cyan: #00e5ff;
  }

  body {
    font-family: 'Space Grotesk', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* ===== CANVAS PARTICLE BACKGROUND ===== */
  #particle-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }

  /* Ambient gradient orbs */
  .ambient-orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(100px);
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
    animation: orbFloat 20s ease-in-out infinite;
  }
  .orb-1 { width: 600px; height: 600px; background: radial-gradient(circle, rgba(0,255,163,0.08), transparent 70%); top: -10%; left: -10%; animation-delay: 0s; }
  .orb-2 { width: 500px; height: 500px; background: radial-gradient(circle, rgba(136,85,255,0.08), transparent 70%); bottom: -10%; right: -10%; animation-delay: -7s; }
  .orb-3 { width: 400px; height: 400px; background: radial-gradient(circle, rgba(0,229,255,0.05), transparent 70%); top: 40%; left: 50%; animation-delay: -14s; }

  @keyframes orbFloat {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -40px) scale(1.1); }
    66% { transform: translate(-20px, 30px) scale(0.9); }
  }

  /* ===== LAYOUT ===== */
  #app {
    position: relative;
    z-index: 1;
  }

  /* Header */
  #header {
    text-align: center;
    padding: 32px 16px 20px;
    position: relative;
  }
  #header h1 {
    font-size: 32px;
    font-weight: 700;
    letter-spacing: 6px;
    text-transform: uppercase;
    color: #fff;
    text-shadow: 0 0 40px rgba(0,255,163,0.3), 0 0 80px rgba(0,255,163,0.1);
  }
  #header .subtitle {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 6px;
    letter-spacing: 4px;
    text-transform: uppercase;
  }
  #header .line {
    width: 120px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-dim), transparent);
    margin: 16px auto 0;
  }

  /* Prestige bar */
  #prestige-bar {
    display: none;
    text-align: center;
    padding: 10px 16px;
    background: rgba(136, 85, 255, 0.05);
    border-bottom: 1px solid rgba(136, 85, 255, 0.1);
    backdrop-filter: blur(20px);
  }
  #prestige-bar.active { display: block; }
  #prestige-bar .prestige-label {
    font-size: 10px;
    color: var(--purple);
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  #prestige-bar .prestige-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    color: var(--purple);
    font-weight: 700;
  }

  /* Stats bar */
  #stats-bar {
    display: flex;
    justify-content: center;
    gap: 40px;
    padding: 20px 16px;
    flex-wrap: wrap;
    background: var(--glass);
    border-top: 1px solid var(--glass-border);
    border-bottom: 1px solid var(--glass-border);
    backdrop-filter: blur(20px);
  }
  .stat { text-align: center; }
  .stat-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }
  .stat-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    text-shadow: 0 0 20px var(--accent-glow);
  }
  .stat-value.gold {
    color: var(--gold);
    text-shadow: 0 0 20px var(--gold-glow);
  }

  /* Save indicator */
  #save-indicator {
    position: fixed;
    top: 12px;
    right: 16px;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .save-btn {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    color: var(--text-dim);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.3s;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .save-btn:hover {
    border-color: var(--accent-dim);
    color: var(--accent);
  }
  #save-status {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 1px;
    transition: all 0.3s;
  }
  #save-status.saving {
    color: var(--accent);
  }

  /* Main layout */
  #main {
    display: grid;
    grid-template-columns: 300px 1fr 340px;
    max-width: 1280px;
    margin: 0 auto;
    min-height: calc(100vh - 200px);
    gap: 1px;
  }

  @media (max-width: 1000px) {
    #main { grid-template-columns: 1fr; }
    #click-panel, #right-panel { border: none; }
  }

  /* ===== LEFT: CLICK ZONE ===== */
  #click-panel {
    padding: 32px 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    border-right: 1px solid var(--glass-border);
  }

  /* Deploy button */
  .deploy-container {
    position: relative;
    width: 220px;
    height: 220px;
  }

  /* Click me indicator */
  .click-indicator {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    letter-spacing: 2px;
    text-transform: uppercase;
    animation: clickPulse 2s ease-in-out infinite;
    z-index: 10;
    white-space: nowrap;
    pointer-events: none;
  }
  .click-indicator::after {
    content: '';
    display: block;
    width: 2px;
    height: 14px;
    background: linear-gradient(to bottom, var(--accent), transparent);
    margin: 4px auto 0;
    animation: clickArrow 2s ease-in-out infinite;
  }
  @keyframes clickPulse {
    0%, 100% { opacity: 1; transform: translateX(-50%) translateY(0); }
    50% { opacity: 0.5; transform: translateX(-50%) translateY(-6px); }
  }
  @keyframes clickArrow {
    0%, 100% { height: 14px; opacity: 1; }
    50% { height: 8px; opacity: 0.4; }
  }
  .click-indicator.hidden {
    animation: fadeAway 1s forwards;
  }
  @keyframes fadeAway {
    to { opacity: 0; pointer-events: none; }
  }

  /* Ring pulse behind button */
  .deploy-ring {
    position: absolute;
    inset: -10px;
    border-radius: 50%;
    border: 1px solid var(--accent-dim);
    animation: ringPulse 3s ease-in-out infinite;
  }
  .deploy-ring:nth-child(2) { animation-delay: 1s; }
  .deploy-ring:nth-child(3) { animation-delay: 2s; }
  @keyframes ringPulse {
    0% { transform: scale(0.9); opacity: 0; }
    50% { opacity: 0.4; }
    100% { transform: scale(1.3); opacity: 0; }
  }

  #deploy-btn {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    border: 1px solid var(--accent-dim);
    background: radial-gradient(circle at 40% 35%, rgba(0,255,163,0.08), rgba(0,0,0,0.4) 70%);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
    position: absolute;
    top: 10px;
    left: 10px;
    overflow: hidden;
    backdrop-filter: blur(10px);
  }
  #deploy-btn::before {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 50%;
    background: conic-gradient(from 0deg, transparent, var(--accent-dim), transparent, transparent);
    animation: btnSpin 4s linear infinite;
    z-index: -1;
  }
  @keyframes btnSpin {
    to { transform: rotate(360deg); }
  }
  #deploy-btn:hover {
    border-color: var(--accent);
    box-shadow: 0 0 60px rgba(0,255,163,0.15), inset 0 0 30px rgba(0,255,163,0.05);
    transform: scale(1.03);
  }
  #deploy-btn:active {
    transform: scale(0.95);
    box-shadow: 0 0 80px rgba(0,255,163,0.25), inset 0 0 40px rgba(0,255,163,0.1);
  }
  #deploy-btn .icon { font-size: 48px; filter: drop-shadow(0 0 10px rgba(0,255,163,0.3)); }
  #deploy-btn .label {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    margin-top: 8px;
    text-transform: uppercase;
    letter-spacing: 3px;
  }
  #deploy-btn .amount {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    color: var(--gold);
    margin-top: 4px;
    text-shadow: 0 0 10px var(--gold-glow);
  }

  .click-float {
    position: absolute;
    pointer-events: none;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 18px;
    color: var(--gold);
    text-shadow: 0 0 10px var(--gold-glow);
    animation: floatUp 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    z-index: 100;
  }
  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-90px) scale(0.6); }
  }

  /* Click upgrades */
  #click-upgrades { width: 100%; }
  #click-upgrades h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }
  .click-upgrade-btn {
    width: 100%;
    padding: 12px 14px;
    margin-bottom: 6px;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    color: var(--text);
    cursor: pointer;
    text-align: left;
    font-size: 12px;
    font-family: 'Space Grotesk', sans-serif;
    transition: all 0.25s;
    backdrop-filter: blur(10px);
  }
  .click-upgrade-btn:hover:not(:disabled) {
    border-color: var(--accent-dim);
    background: rgba(0,255,163,0.03);
    box-shadow: 0 0 20px rgba(0,255,163,0.05);
  }
  .click-upgrade-btn:disabled {
    opacity: 0.25;
    cursor: not-allowed;
  }
  .click-upgrade-btn .name { font-weight: 600; }
  .click-upgrade-btn .cost {
    font-family: 'JetBrains Mono', monospace;
    color: var(--gold);
    float: right;
    font-size: 11px;
  }
  .click-upgrade-btn .desc {
    display: block;
    color: var(--text-dim);
    font-size: 10px;
    margin-top: 3px;
  }

  /* ===== CENTER: AGENT STORE ===== */
  #store-panel {
    padding: 28px 24px;
    overflow-y: auto;
  }
  #store-panel h2 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 4px;
    color: var(--text-muted);
    margin-bottom: 20px;
  }

  .agent-card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    padding: 16px 18px;
    margin-bottom: 10px;
    display: grid;
    grid-template-columns: 48px 1fr auto;
    gap: 14px;
    align-items: center;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
  }
  .agent-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
  }
  .agent-card:hover:not(.locked) {
    border-color: rgba(0,255,163,0.2);
    background: rgba(0,255,163,0.02);
    box-shadow: 0 8px 40px rgba(0,0,0,0.3), 0 0 30px rgba(0,255,163,0.03);
    transform: translateY(-2px);
  }
  .agent-card.locked {
    opacity: 0.2;
    cursor: not-allowed;
  }
  .agent-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(5px);
  }
  .agent-info .agent-name {
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
  }
  .agent-info .agent-desc {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 3px;
    line-height: 1.4;
  }
  .agent-info .agent-production {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--accent-dim);
    margin-top: 5px;
  }
  .agent-buy { text-align: right; }
  .agent-buy .agent-cost {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 700;
    color: var(--gold);
    text-shadow: 0 0 10px var(--gold-glow);
  }
  .agent-buy .agent-owned {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 3px;
    letter-spacing: 1px;
  }

  /* ===== RIGHT PANEL ===== */
  #right-panel {
    border-left: 1px solid var(--glass-border);
    display: flex;
    flex-direction: column;
  }

  #milestones-panel {
    padding: 20px;
    border-bottom: 1px solid var(--glass-border);
    max-height: 50%;
    overflow-y: auto;
  }
  #milestones-panel h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }
  .milestone {
    padding: 10px 12px;
    margin-bottom: 6px;
    border-radius: 10px;
    font-size: 12px;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    transition: all 0.3s;
  }
  .milestone.achieved {
    border-color: rgba(0,255,163,0.15);
    background: rgba(0,255,163,0.03);
    box-shadow: 0 0 20px rgba(0,255,163,0.03);
  }
  .milestone .m-name { font-weight: 600; font-size: 12px; }
  .milestone .m-desc { color: var(--text-dim); font-size: 10px; margin-top: 2px; }
  .milestone .m-reward { color: var(--accent); font-size: 10px; font-weight: 600; margin-top: 2px; }

  /* Log */
  #log-panel {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
  }
  #log-panel h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }
  #log {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    line-height: 1.8;
  }
  #log .log-entry { margin-bottom: 2px; }
  #log .log-money { color: var(--gold); }
  #log .log-good { color: var(--accent); }

  /* ===== PRESTIGE MODAL ===== */
  #prestige-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(20px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  #prestige-overlay.active { display: flex; }
  #prestige-modal {
    background: var(--surface-solid);
    border: 1px solid rgba(136,85,255,0.2);
    border-radius: 20px;
    padding: 40px;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 0 100px rgba(136,85,255,0.1);
  }
  #prestige-modal h2 {
    font-size: 24px;
    color: var(--purple);
    margin-bottom: 12px;
    letter-spacing: 2px;
    text-shadow: 0 0 30px var(--purple-glow);
  }
  #prestige-modal p {
    color: var(--text-dim);
    font-size: 13px;
    margin-bottom: 16px;
    line-height: 1.6;
  }
  #prestige-modal .prestige-info {
    font-family: 'JetBrains Mono', monospace;
    color: var(--purple);
    font-size: 20px;
    font-weight: 700;
    margin: 16px 0;
    text-shadow: 0 0 20px var(--purple-glow);
  }
  .prestige-btn {
    padding: 12px 36px;
    border: 1px solid rgba(136,85,255,0.3);
    background: rgba(136,85,255,0.05);
    color: var(--purple);
    font-family: 'Space Grotesk', sans-serif;
    font-weight: 600;
    font-size: 13px;
    border-radius: 10px;
    cursor: pointer;
    margin: 6px;
    transition: all 0.25s;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .prestige-btn:hover { background: var(--purple); color: #fff; box-shadow: 0 0 30px var(--purple-glow); }
  .prestige-btn.cancel { border-color: var(--glass-border); color: var(--text-dim); background: transparent; }
  .prestige-btn.cancel:hover { background: rgba(255,255,255,0.05); color: var(--text); }

  #prestige-trigger {
    display: none;
    margin: 8px auto;
    padding: 8px 20px;
    border: 1px solid rgba(136,85,255,0.2);
    background: rgba(136,85,255,0.05);
    color: var(--purple);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 11px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 0.25s;
    backdrop-filter: blur(10px);
  }
  #prestige-trigger:hover { background: var(--purple); color: #fff; }
  #prestige-trigger.visible { display: inline-block; }

  /* ===== NFT HASH MODAL ===== */
  #nft-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(30px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  #nft-overlay.active { display: flex; }
  #nft-modal {
    background: var(--surface-solid);
    border: 1px solid rgba(255,208,0,0.2);
    border-radius: 20px;
    padding: 48px;
    max-width: 560px;
    text-align: center;
    box-shadow: 0 0 120px rgba(255,208,0,0.08);
    position: relative;
    overflow: hidden;
  }
  #nft-modal::before {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 22px;
    background: conic-gradient(from 0deg, transparent 40%, var(--gold), transparent 60%);
    animation: nftSpin 6s linear infinite;
    z-index: -1;
    opacity: 0.3;
  }
  @keyframes nftSpin { to { transform: rotate(360deg); } }
  #nft-modal .nft-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--gold);
    letter-spacing: 3px;
    text-transform: uppercase;
    text-shadow: 0 0 40px var(--gold-glow);
    margin-bottom: 8px;
  }
  #nft-modal .nft-sub {
    font-size: 12px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 28px;
  }
  #nft-hash-display {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    background: rgba(0,255,163,0.03);
    border: 1px solid rgba(0,255,163,0.15);
    border-radius: 10px;
    padding: 16px 20px;
    word-break: break-all;
    line-height: 1.8;
    letter-spacing: 1px;
    text-shadow: 0 0 10px var(--accent-glow);
    margin-bottom: 20px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }
  #nft-hash-display:hover {
    background: rgba(0,255,163,0.06);
  }
  #nft-hash-display .copy-hint {
    display: block;
    font-size: 9px;
    color: var(--text-muted);
    margin-top: 8px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  #nft-modal .nft-note {
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.6;
    margin-bottom: 24px;
  }
  .nft-close-btn {
    padding: 10px 28px;
    border: 1px solid var(--glass-border);
    background: transparent;
    color: var(--text-dim);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 12px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.25s;
  }
  .nft-close-btn:hover { border-color: var(--accent-dim); color: var(--accent); }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface-solid);
    border: 1px solid var(--accent-dim);
    border-radius: 10px;
    padding: 12px 24px;
    font-size: 12px;
    color: var(--accent);
    z-index: 2000;
    backdrop-filter: blur(20px);
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1), toastOut 0.5s 2.5s forwards;
    letter-spacing: 1px;
  }
  @keyframes toastIn {
    from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
  }
  @keyframes toastOut {
    to { opacity: 0; transform: translateX(-50%) translateY(-10px); }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 2px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

  /* SFX toggle */
  #sfx-toggle {
    position: fixed;
    top: 12px;
    left: 16px;
    z-index: 100;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    color: var(--text-dim);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.3s;
    letter-spacing: 1px;
  }
  #sfx-toggle:hover { border-color: var(--accent-dim); color: var(--accent); }
  #sfx-toggle.muted { opacity: 0.4; }
</style>
</head>
<body>

<!-- Ambient orbs -->
<div class="ambient-orb orb-1"></div>
<div class="ambient-orb orb-2"></div>
<div class="ambient-orb orb-3"></div>

<!-- Particle canvas -->
<canvas id="particle-canvas"></canvas>

<!-- SFX toggle -->
<button id="sfx-toggle" onclick="toggleSFX()">SFX ON</button>

<!-- Save indicator -->
<div id="save-indicator">
  <span id="save-status">auto-saved</span>
  <button class="save-btn" onclick="manualSave()">SAVE</button>
  <button class="save-btn" onclick="exportSave()">EXPORT</button>
  <button class="save-btn" onclick="importSave()">IMPORT</button>
</div>

<div id="app">

<div id="header">
  <h1>Escape the Underclass</h1>
  <div class="subtitle">Deploy AI Agents &middot; Stack ARR &middot; Get Out</div>
  <div class="line"></div>
</div>

<div id="prestige-bar">
  <span class="prestige-label">Venture Capital Rounds: </span>
  <span class="prestige-count" id="vc-rounds">0</span>
  <span class="prestige-label"> &mdash; All income &times;<span id="vc-mult">1.0</span></span>
</div>

<div id="stats-bar">
  <div class="stat">
    <div class="stat-label">MRR</div>
    <div class="stat-value" id="mrr-display">$0</div>
  </div>
  <div class="stat">
    <div class="stat-label">ARR</div>
    <div class="stat-value gold" id="arr-display">$0</div>
  </div>
  <div class="stat">
    <div class="stat-label">$/sec</div>
    <div class="stat-value" id="dps-display">$0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Total Earned</div>
    <div class="stat-value" id="total-display">$0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Agents</div>
    <div class="stat-value" id="agents-display">0</div>
  </div>
</div>

<div id="main">
  <div id="click-panel">
    <div class="deploy-container">
      <div class="click-indicator" id="click-indicator">Click to Deploy</div>
      <div class="deploy-ring"></div>
      <div class="deploy-ring"></div>
      <div class="deploy-ring"></div>
      <div id="deploy-btn" onclick="handleClick(event)">
        <span class="icon">ðŸ¤–</span>
        <span class="label">Deploy</span>
        <span class="amount" id="click-value">+$1</span>
      </div>
    </div>
    <button id="prestige-trigger" onclick="showPrestige()">Raise VC Round</button>
    <div id="click-upgrades">
      <h3>Hustle Upgrades</h3>
      <div id="click-upgrade-list"></div>
    </div>
  </div>

  <div id="store-panel">
    <h2>AI Agents</h2>
    <div id="agent-store"></div>
  </div>

  <div id="right-panel">
    <div id="milestones-panel">
      <h3>Milestones</h3>
      <div id="milestone-list"></div>
    </div>
    <div id="log-panel">
      <h3>Activity Log</h3>
      <div id="log"></div>
    </div>
  </div>
</div>

</div>

<!-- Prestige modal -->
<div id="prestige-overlay">
  <div id="prestige-modal">
    <h2>Raise a VC Round</h2>
    <p>Cash out your ARR to attract venture capital. You'll lose all agents and MRR, but gain permanent income multipliers.</p>
    <div class="prestige-info">You'll gain <span id="prestige-gain">0</span> VC points</div>
    <p>Each VC point gives +10% to all income. Current multiplier: &times;<span id="prestige-current-mult">1.0</span></p>
    <div>
      <button class="prestige-btn" onclick="doPrestige()">Raise the Round</button>
      <button class="prestige-btn cancel" onclick="hidePrestige()">Not Yet</button>
    </div>
  </div>
</div>

<!-- NFT Hash modal -->
<div id="nft-overlay">
  <div id="nft-modal">
    <div class="nft-title">You Escaped</div>
    <div class="nft-sub">$1 Trillion ARR Achieved</div>
    <div id="nft-hash-display" onclick="copyHash()">
      <span id="nft-hash-text"></span>
      <span class="copy-hint">Click to copy</span>
    </div>
    <div class="nft-note">Save this hash. It is your proof of escape â€” use it to mint your NFT.</div>
    <button class="nft-close-btn" onclick="closeNFT()">Continue Playing</button>
  </div>
</div>

<script>
// ============ SOUND FX (Web Audio API) ============
let sfxEnabled = true;
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function toggleSFX() {
  sfxEnabled = !sfxEnabled;
  const btn = document.getElementById('sfx-toggle');
  btn.textContent = sfxEnabled ? 'SFX ON' : 'SFX OFF';
  btn.classList.toggle('muted', !sfxEnabled);
}

function playSFX(type) {
  if (!sfxEnabled) return;
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);

    const now = ctx.currentTime;

    switch (type) {
      case 'click':
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, now);
        osc.frequency.exponentialRampToValueAtTime(1320, now + 0.05);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
        break;

      case 'buy':
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.08);
        osc.frequency.exponentialRampToValueAtTime(1100, now + 0.15);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.start(now);
        osc.stop(now + 0.2);
        break;

      case 'upgrade':
        osc.type = 'sine';
        osc.frequency.setValueAtTime(523, now);
        osc.frequency.setValueAtTime(659, now + 0.08);
        osc.frequency.setValueAtTime(784, now + 0.16);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc.start(now);
        osc.stop(now + 0.3);
        break;

      case 'milestone': {
        // Play a chord
        const freqs = [523, 659, 784, 1047];
        freqs.forEach((f, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.type = 'sine';
          o.frequency.setValueAtTime(f, now + i * 0.06);
          g.gain.setValueAtTime(0.06, now + i * 0.06);
          g.gain.exponentialRampToValueAtTime(0.001, now + 0.5 + i * 0.06);
          o.start(now + i * 0.06);
          o.stop(now + 0.6 + i * 0.06);
        });
        return; // already handled
      }

      case 'prestige': {
        const freqs = [262, 330, 392, 523, 659, 784];
        freqs.forEach((f, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.type = 'sine';
          o.frequency.setValueAtTime(f, now + i * 0.08);
          g.gain.setValueAtTime(0.08, now + i * 0.08);
          g.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
          o.start(now + i * 0.08);
          o.stop(now + 1.0);
        });
        return;
      }

      case 'escape': {
        // Epic ascending arpeggio
        const freqs = [262, 330, 392, 523, 659, 784, 1047, 1319, 1568];
        freqs.forEach((f, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.type = 'sine';
          o.frequency.setValueAtTime(f, now + i * 0.1);
          g.gain.setValueAtTime(0.07, now + i * 0.1);
          g.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
          o.start(now + i * 0.1);
          o.stop(now + 2.0);
        });
        return;
      }

      case 'deny':
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.exponentialRampToValueAtTime(150, now + 0.15);
        gain.gain.setValueAtTime(0.04, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.start(now);
        osc.stop(now + 0.15);
        break;

      default:
        return;
    }
  } catch (e) {
    // Audio not available
  }
}


// ============ PARTICLE SYSTEM ============
const canvas = document.getElementById('particle-canvas');
const pCtx = canvas.getContext('2d');
let particles = [];
let mouseX = 0, mouseY = 0;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);
document.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });

function initParticles() {
  particles = [];
  const count = Math.min(80, Math.floor(window.innerWidth * window.innerHeight / 15000));
  for (let i = 0; i < count; i++) {
    particles.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.3,
      vy: (Math.random() - 0.5) * 0.3,
      size: Math.random() * 1.5 + 0.5,
      alpha: Math.random() * 0.3 + 0.05,
    });
  }
}
initParticles();

function drawParticles() {
  pCtx.clearRect(0, 0, canvas.width, canvas.height);

  for (const p of particles) {
    // Subtle mouse repulsion
    const dx = p.x - mouseX;
    const dy = p.y - mouseY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < 150) {
      const force = (150 - dist) / 150 * 0.02;
      p.vx += dx / dist * force;
      p.vy += dy / dist * force;
    }

    p.x += p.vx;
    p.y += p.vy;
    p.vx *= 0.99;
    p.vy *= 0.99;

    if (p.x < 0) p.x = canvas.width;
    if (p.x > canvas.width) p.x = 0;
    if (p.y < 0) p.y = canvas.height;
    if (p.y > canvas.height) p.y = 0;

    pCtx.beginPath();
    pCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    pCtx.fillStyle = `rgba(0, 255, 163, ${p.alpha})`;
    pCtx.fill();
  }

  // Draw connections
  for (let i = 0; i < particles.length; i++) {
    for (let j = i + 1; j < particles.length; j++) {
      const dx = particles[i].x - particles[j].x;
      const dy = particles[i].y - particles[j].y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 120) {
        pCtx.beginPath();
        pCtx.moveTo(particles[i].x, particles[i].y);
        pCtx.lineTo(particles[j].x, particles[j].y);
        pCtx.strokeStyle = `rgba(0, 255, 163, ${0.03 * (1 - dist / 120)})`;
        pCtx.lineWidth = 0.5;
        pCtx.stroke();
      }
    }
  }

  requestAnimationFrame(drawParticles);
}
drawParticles();


// ============ GAME STATE ============
let state = {
  mrr: 0,
  totalEarned: 0,
  totalAllTime: 0,
  clickValue: 1,
  clickMultiplier: 1,
  agents: {},
  clickUpgrades: {},
  milestones: {},
  vcPoints: 0,
  vcRounds: 0,
  totalClicks: 0,
  nftHash: null,
  escaped: false,
};

// ============ AGENT DEFINITIONS ============
const AGENTS = [
  { id: 'chatbot', name: 'Customer Support Bot', desc: 'A basic chatbot handling FAQ tickets. Cheap but honest work.', icon: 'ðŸ’¬', iconBg: 'rgba(20,40,60,0.5)', baseCost: 15, baseMps: 0.1, costScale: 1.15, unlockAt: 0 },
  { id: 'content', name: 'Content Writer Agent', desc: 'Generates SEO blog posts while you sleep. Quality varies.', icon: 'âœï¸', iconBg: 'rgba(40,20,60,0.5)', baseCost: 100, baseMps: 1, costScale: 1.15, unlockAt: 100 },
  { id: 'scraper', name: 'Lead Scraper', desc: 'Crawls LinkedIn and builds prospect lists. Ethically questionable.', icon: 'ðŸ•·ï¸', iconBg: 'rgba(60,40,20,0.5)', baseCost: 1_100, baseMps: 8, costScale: 1.15, unlockAt: 1_000 },
  { id: 'sdr', name: 'AI SDR', desc: '"Just following up on my last email..." Sends cold outreach at scale.', icon: 'ðŸ“§', iconBg: 'rgba(20,60,40,0.5)', baseCost: 12_000, baseMps: 47, costScale: 1.15, unlockAt: 10_000 },
  { id: 'coder', name: 'Vibe Coder', desc: 'Ships MVP features in hours. Leaves TODOs everywhere.', icon: 'ðŸ‘¨â€ðŸ’»', iconBg: 'rgba(40,40,60,0.5)', baseCost: 130_000, baseMps: 260, costScale: 1.15, unlockAt: 100_000 },
  { id: 'analyst', name: 'Data Analyst Agent', desc: 'Builds dashboards and finds "insights". Loves pie charts.', icon: 'ðŸ“Š', iconBg: 'rgba(60,20,40,0.5)', baseCost: 1_400_000, baseMps: 1_400, costScale: 1.15, unlockAt: 1_000_000 },
  { id: 'pm', name: 'AI Product Manager', desc: 'Writes PRDs, creates Jira tickets, schedules standups. No one asked for this.', icon: 'ðŸ“‹', iconBg: 'rgba(20,20,60,0.5)', baseCost: 20_000_000, baseMps: 7_800, costScale: 1.15, unlockAt: 10_000_000 },
  { id: 'founder', name: 'AI Co-Founder', desc: 'Runs an entire micro-SaaS autonomously. Wants equity.', icon: 'ðŸ§ ', iconBg: 'rgba(40,20,20,0.5)', baseCost: 330_000_000, baseMps: 44_000, costScale: 1.15, unlockAt: 100_000_000 },
  { id: 'swarm', name: 'Agent Swarm', desc: 'A self-replicating cluster of agents. They have meetings now.', icon: 'ðŸ', iconBg: 'rgba(40,60,20,0.5)', baseCost: 5_100_000_000, baseMps: 260_000, costScale: 1.15, unlockAt: 1_000_000_000 },
  { id: 'agi', name: 'AGI (Probably)', desc: 'It passed the Turing test. It also passed your annual review.', icon: 'ðŸŒŒ', iconBg: 'rgba(20,20,40,0.5)', baseCost: 75_000_000_000, baseMps: 1_600_000, costScale: 1.15, unlockAt: 10_000_000_000 },
];

// ============ CLICK UPGRADES ============
const CLICK_UPGRADES = [
  { id: 'cursor1', name: 'Faster Typing', desc: 'Double click value', cost: 100, multiplier: 2 },
  { id: 'cursor2', name: 'Mechanical Keyboard', desc: 'Triple click value', cost: 5_000, multiplier: 3 },
  { id: 'cursor3', name: 'Dual Monitors', desc: '5x click value', cost: 50_000, multiplier: 5 },
  { id: 'cursor4', name: 'Standing Desk', desc: '10x click value', cost: 500_000, multiplier: 10 },
  { id: 'cursor5', name: 'Neuralink Beta', desc: '50x click value', cost: 50_000_000, multiplier: 50 },
  { id: 'cursor6', name: 'Matrix Plugin', desc: '500x click value', cost: 50_000_000_000, multiplier: 500 },
];

// ============ MILESTONES ============
const MILESTONES = [
  { id: 'm1', name: 'First Dollar', desc: 'Earn your first $1', threshold: 1, reward: 'Unlocked the grind', multiplier: 1 },
  { id: 'm2', name: 'Ramen Profitable', desc: 'Reach $1,000 total', threshold: 1_000, reward: '+5% all income', multiplier: 1.05 },
  { id: 'm3', name: 'Quit Your Day Job', desc: 'Reach $100,000 total', threshold: 100_000, reward: '+10% all income', multiplier: 1.10 },
  { id: 'm4', name: 'Default Alive', desc: 'Reach $10M total', threshold: 10_000_000, reward: '+15% all income', multiplier: 1.15 },
  { id: 'm5', name: 'YC Interview', desc: 'Reach $100M total', threshold: 100_000_000, reward: '+20% all income', multiplier: 1.20 },
  { id: 'm6', name: 'Series A', desc: 'Reach $1B total', threshold: 1_000_000_000, reward: '+25% all income', multiplier: 1.25 },
  { id: 'm7', name: 'Unicorn Status', desc: 'Reach $100B total', threshold: 100_000_000_000, reward: '+30% all income', multiplier: 1.30 },
  { id: 'm8', name: 'Escaped', desc: 'Reach $1T total', threshold: 1_000_000_000_000, reward: 'You made it.', multiplier: 1.50 },
];

// ============ HELPERS ============
function formatMoney(n) {
  if (n < 0) return '-' + formatMoney(-n);
  if (n < 1000) return '$' + n.toFixed(n < 10 ? 1 : 0);
  const units = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc'];
  const tier = Math.min(Math.floor(Math.log10(n) / 3), units.length - 1);
  const scaled = n / Math.pow(10, tier * 3);
  return '$' + scaled.toFixed(scaled < 10 ? 2 : scaled < 100 ? 1 : 0) + units[tier];
}

function getAgentCost(agent) {
  const owned = state.agents[agent.id] || 0;
  return Math.floor(agent.baseCost * Math.pow(agent.costScale, owned));
}

function getMilestoneMultiplier() {
  let mult = 1;
  for (const m of MILESTONES) {
    if (state.milestones[m.id]) mult *= m.multiplier;
  }
  return mult;
}

function getVCMultiplier() {
  return 1 + state.vcPoints * 0.10;
}

function getClickValue() {
  return state.clickValue * state.clickMultiplier * getMilestoneMultiplier() * getVCMultiplier();
}

function getMPS() {
  let total = 0;
  for (const agent of AGENTS) {
    const owned = state.agents[agent.id] || 0;
    total += owned * agent.baseMps;
  }
  return total * getMilestoneMultiplier() * getVCMultiplier();
}

function getTotalAgents() {
  let total = 0;
  for (const a of AGENTS) total += (state.agents[a.id] || 0);
  return total;
}

function log(msg) {
  const el = document.getElementById('log');
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML = msg;
  el.prepend(entry);
  while (el.children.length > 50) el.removeChild(el.lastChild);
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// ============ NFT HASH GENERATION ============
async function generateEscapeHash() {
  // Build a deterministic payload from game state
  const payload = [
    'ESCAPE_THE_UNDERCLASS_V1',
    state.totalAllTime.toFixed(0),
    state.vcRounds,
    state.vcPoints,
    state.totalClicks,
    getTotalAgents(),
    Date.now(),
    Math.random().toString(36).slice(2),
  ].join('|');

  // Use SubtleCrypto SHA-256
  const encoder = new TextEncoder();
  const data = encoder.encode(payload);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return '0x' + hashHex;
}

function showNFTModal(hash) {
  document.getElementById('nft-hash-text').textContent = hash;
  document.getElementById('nft-overlay').classList.add('active');
  playSFX('escape');
}

function closeNFT() {
  document.getElementById('nft-overlay').classList.remove('active');
}

function copyHash() {
  const hash = document.getElementById('nft-hash-text').textContent;
  navigator.clipboard.writeText(hash).then(() => {
    toast('Hash copied to clipboard!');
  }).catch(() => {
    // Fallback: select text
    const range = document.createRange();
    range.selectNodeContents(document.getElementById('nft-hash-text'));
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });
}

// ============ CLICK HANDLER ============
let clickIndicatorHidden = false;

function handleClick(e) {
  const value = getClickValue();
  state.mrr += value;
  state.totalEarned += value;
  state.totalAllTime += value;
  state.totalClicks = (state.totalClicks || 0) + 1;

  playSFX('click');

  // Hide click indicator after first click
  if (!clickIndicatorHidden) {
    clickIndicatorHidden = true;
    document.getElementById('click-indicator').classList.add('hidden');
  }

  // Float animation
  const btn = document.getElementById('deploy-btn');
  const rect = btn.getBoundingClientRect();
  const float = document.createElement('div');
  float.className = 'click-float';
  float.textContent = '+' + formatMoney(value);
  float.style.left = (e.clientX - rect.left - 20) + 'px';
  float.style.top = (e.clientY - rect.top - 10) + 'px';
  btn.appendChild(float);
  setTimeout(() => float.remove(), 1000);
}

// ============ BUY AGENT ============
function buyAgent(agentId) {
  const agent = AGENTS.find(a => a.id === agentId);
  if (!agent) return;
  const cost = getAgentCost(agent);
  if (state.mrr < cost) { playSFX('deny'); return; }
  if (state.totalAllTime < agent.unlockAt) return;

  state.mrr -= cost;
  state.agents[agent.id] = (state.agents[agent.id] || 0) + 1;
  playSFX('buy');
  log(`Deployed <span class="log-good">${agent.name}</span> #${state.agents[agent.id]} for <span class="log-money">${formatMoney(cost)}</span>`);
  renderStore();
}

// ============ BUY CLICK UPGRADE ============
function buyClickUpgrade(upId) {
  const up = CLICK_UPGRADES.find(u => u.id === upId);
  if (!up || state.clickUpgrades[upId]) return;
  if (state.mrr < up.cost) { playSFX('deny'); return; }

  state.mrr -= up.cost;
  state.clickUpgrades[upId] = true;
  state.clickMultiplier *= up.multiplier;
  playSFX('upgrade');
  log(`Upgraded: <span class="log-good">${up.name}</span> â€” click value x${up.multiplier}`);
  renderClickUpgrades();
}

// ============ PRESTIGE ============
function getPrestigeGain() {
  return Math.floor(Math.sqrt(state.totalEarned / 1_000_000_000));
}

function showPrestige() {
  const gain = getPrestigeGain();
  document.getElementById('prestige-gain').textContent = gain;
  document.getElementById('prestige-current-mult').textContent = ((1 + (state.vcPoints + gain) * 0.10)).toFixed(1);
  document.getElementById('prestige-overlay').classList.add('active');
}

function hidePrestige() {
  document.getElementById('prestige-overlay').classList.remove('active');
}

function doPrestige() {
  const gain = getPrestigeGain();
  if (gain < 1) { hidePrestige(); return; }

  state.vcPoints += gain;
  state.vcRounds++;
  state.mrr = 0;
  state.totalEarned = 0;
  state.clickValue = 1;
  state.clickMultiplier = 1;
  state.agents = {};
  state.clickUpgrades = {};

  playSFX('prestige');
  log(`<span class="log-good">VC Round #${state.vcRounds}!</span> Gained ${gain} VC points. Multiplier: x${getVCMultiplier().toFixed(1)}`);
  toast(`VC Round raised! +${gain} points`);
  hidePrestige();
  renderAll();
}

// ============ MILESTONES CHECK ============
let escapeTriggered = false;

function checkMilestones() {
  for (const m of MILESTONES) {
    if (!state.milestones[m.id] && state.totalAllTime >= m.threshold) {
      state.milestones[m.id] = true;
      playSFX('milestone');
      log(`<span class="log-good">Milestone: ${m.name}!</span> ${m.reward}`);
      toast(`Milestone: ${m.name}!`);

      // $1T escape â€” generate NFT hash
      if (m.id === 'm8' && !state.escaped && !escapeTriggered) {
        escapeTriggered = true;
        state.escaped = true;
        generateEscapeHash().then(hash => {
          state.nftHash = hash;
          save();
          showNFTModal(hash);
        });
      }
    }
  }
}

// ============ RENDER ============
function renderStore() {
  const el = document.getElementById('agent-store');
  el.innerHTML = '';
  for (const agent of AGENTS) {
    const cost = getAgentCost(agent);
    const owned = state.agents[agent.id] || 0;
    const locked = state.totalAllTime < agent.unlockAt;
    const canBuy = state.mrr >= cost && !locked;

    const card = document.createElement('div');
    card.className = 'agent-card' + (locked ? ' locked' : '');
    if (!locked) card.onclick = () => buyAgent(agent.id);

    const production = owned > 0
      ? `producing ${formatMoney(owned * agent.baseMps * getMilestoneMultiplier() * getVCMultiplier())}/s`
      : `each: ${formatMoney(agent.baseMps * getMilestoneMultiplier() * getVCMultiplier())}/s`;

    card.innerHTML = `
      <div class="agent-icon" style="background:${agent.iconBg}">${locked ? 'ðŸ”’' : agent.icon}</div>
      <div class="agent-info">
        <div class="agent-name">${locked ? '???' : agent.name}</div>
        <div class="agent-desc">${locked ? `Unlocks at ${formatMoney(agent.unlockAt)} total earned` : agent.desc}</div>
        <div class="agent-production">${locked ? '' : production}</div>
      </div>
      <div class="agent-buy">
        <div class="agent-cost" style="color:${canBuy ? 'var(--gold)' : 'var(--red)'}">${locked ? 'ðŸ”’' : formatMoney(cost)}</div>
        <div class="agent-owned">${locked ? '' : 'owned: ' + owned}</div>
      </div>
    `;
    el.appendChild(card);
  }
}

function renderClickUpgrades() {
  const el = document.getElementById('click-upgrade-list');
  el.innerHTML = '';
  for (const up of CLICK_UPGRADES) {
    if (state.clickUpgrades[up.id]) continue;
    const btn = document.createElement('button');
    btn.className = 'click-upgrade-btn';
    btn.disabled = state.mrr < up.cost;
    btn.onclick = () => buyClickUpgrade(up.id);
    btn.innerHTML = `
      <span class="name">${up.name}</span>
      <span class="cost">${formatMoney(up.cost)}</span>
      <span class="desc">${up.desc}</span>
    `;
    el.appendChild(btn);
  }
}

function renderMilestones() {
  const el = document.getElementById('milestone-list');
  el.innerHTML = '';
  for (const m of MILESTONES) {
    const achieved = !!state.milestones[m.id];
    const div = document.createElement('div');
    div.className = 'milestone' + (achieved ? ' achieved' : '');
    div.innerHTML = `
      <div class="m-name">${achieved ? 'âœ“ ' : ''}${m.name}</div>
      <div class="m-desc">${m.desc}</div>
      <div class="m-reward">${m.reward}</div>
    `;
    el.appendChild(div);
  }
}

function renderAll() {
  renderStore();
  renderClickUpgrades();
  renderMilestones();
}

function updateDisplay() {
  const mps = getMPS();
  document.getElementById('mrr-display').textContent = formatMoney(state.mrr);
  document.getElementById('arr-display').textContent = formatMoney(state.mrr * 12);
  document.getElementById('dps-display').textContent = formatMoney(mps);
  document.getElementById('total-display').textContent = formatMoney(state.totalAllTime);
  document.getElementById('agents-display').textContent = getTotalAgents();
  document.getElementById('click-value').textContent = '+' + formatMoney(getClickValue());

  const gain = getPrestigeGain();
  const trigger = document.getElementById('prestige-trigger');
  trigger.classList.toggle('visible', gain >= 1);
  if (state.vcRounds > 0) {
    document.getElementById('prestige-bar').classList.add('active');
    document.getElementById('vc-rounds').textContent = state.vcRounds;
    document.getElementById('vc-mult').textContent = getVCMultiplier().toFixed(1);
  }
}

// ============ GAME LOOP ============
let lastTick = Date.now();

function tick() {
  const now = Date.now();
  const dt = (now - lastTick) / 1000;
  lastTick = now;

  const mps = getMPS();
  const earned = mps * dt;
  state.mrr += earned;
  state.totalEarned += earned;
  state.totalAllTime += earned;

  checkMilestones();
  updateDisplay();
}

setInterval(() => { renderStore(); renderClickUpgrades(); }, 1000);
setInterval(tick, 33);

// ============ SAVE / LOAD ============
const SAVE_KEY = 'escape_underclass_save';

function save() {
  try {
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    const el = document.getElementById('save-status');
    el.textContent = 'saved';
    el.classList.add('saving');
    setTimeout(() => {
      el.textContent = 'auto-saved';
      el.classList.remove('saving');
    }, 1500);
  } catch (e) { /* storage full or unavailable */ }
}

function load() {
  try {
    const data = localStorage.getItem(SAVE_KEY);
    if (data) {
      const parsed = JSON.parse(data);
      state = { ...state, ...parsed };
      log('<span class="log-good">Progress restored.</span>');

      // Restore click indicator state
      if (state.totalClicks > 0) {
        clickIndicatorHidden = true;
        document.getElementById('click-indicator').classList.add('hidden');
      }

      // Restore escape state
      if (state.escaped) escapeTriggered = true;
    }
  } catch (e) { /* corrupted save */ }
}

function manualSave() {
  save();
  toast('Progress saved.');
  playSFX('click');
}

function exportSave() {
  const data = JSON.stringify(state);
  const encoded = btoa(data);
  navigator.clipboard.writeText(encoded).then(() => {
    toast('Save code copied to clipboard!');
    playSFX('upgrade');
  }).catch(() => {
    // Fallback: prompt
    prompt('Copy this save code:', encoded);
  });
}

function importSave() {
  const code = prompt('Paste your save code:');
  if (!code) return;
  try {
    const data = JSON.parse(atob(code));
    state = { ...state, ...data };
    renderAll();
    toast('Save imported!');
    playSFX('milestone');
    save();
  } catch (e) {
    toast('Invalid save code.');
    playSFX('deny');
  }
}

// Auto-save every 30s
setInterval(save, 30000);
window.addEventListener('beforeunload', save);

// ============ INIT ============
load();
renderAll();
log('Welcome to <span class="log-good">Escape the Underclass</span>.');
log('Deploy agents. Stack ARR. Reach <span class="log-money">$1T</span> to escape.');

// If player already has NFT hash, show option to view it
if (state.nftHash) {
  log(`<span class="log-good">Your escape hash is saved.</span> <span class="log-money" style="cursor:pointer;text-decoration:underline" onclick="showNFTModal('${state.nftHash}')">View hash</span>`);
}
</script>

</body>
</html>
