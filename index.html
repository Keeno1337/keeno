<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Escape the Underclass</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500;600;700&family=Instrument+Serif:ital@0;1&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface-solid: #141414;
    --surface2: #1a1a1a;
    --glass: rgba(255, 255, 255, 0.04);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text: #e0ddd5;
    --text-dim: #7a7770;
    --text-muted: #4a4843;
    --accent: #e8c547;
    --accent-glow: rgba(232, 197, 71, 0.08);
    --accent-dim: rgba(232, 197, 71, 0.4);
    --gold: #e8c547;
    --gold-glow: rgba(232, 197, 71, 0.08);
    --red: #c4423a;
    --blue: #5b8fd9;
    --purple: #9b7ed9;
    --purple-glow: rgba(155, 126, 217, 0.1);
    --neon-pink: #d94f6b;
    --neon-cyan: #6bc4b8;
  }

  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* ===== CANVAS PARTICLE BACKGROUND ===== */
  #particle-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }

  /* Ambient gradient orbs â€” subtle warmth */
  .ambient-orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(150px);
    pointer-events: none;
    z-index: 0;
    opacity: 0.25;
  }
  .orb-1 { width: 600px; height: 600px; background: radial-gradient(circle, rgba(232,197,71,0.04), transparent 70%); top: -10%; left: -10%; }
  .orb-2 { width: 500px; height: 500px; background: radial-gradient(circle, rgba(155,126,217,0.03), transparent 70%); bottom: -10%; right: -10%; }
  .orb-3 { display: none; }

  /* ===== LAYOUT ===== */
  #app {
    position: relative;
    z-index: 1;
  }

  /* Header */
  #header {
    text-align: center;
    padding: 32px 16px 20px;
    position: relative;
  }
  #header h1 {
    font-family: 'Instrument Serif', Georgia, serif;
    font-size: 38px;
    font-weight: 400;
    font-style: italic;
    letter-spacing: 1px;
    color: var(--text);
  }
  #header .subtitle {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 6px;
    letter-spacing: 4px;
    text-transform: uppercase;
  }
  #header .line {
    width: 60px;
    height: 2px;
    background: var(--accent);
    margin: 14px auto 0;
    opacity: 0.4;
  }

  /* Prestige bar */
  #prestige-bar {
    display: none;
    text-align: center;
    padding: 10px 16px;
    background: rgba(155, 126, 217, 0.04);
    border-bottom: 1px solid rgba(155, 126, 217, 0.1);
  }
  #prestige-bar.active { display: block; }
  #prestige-bar .prestige-label {
    font-size: 10px;
    color: var(--purple);
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  #prestige-bar .prestige-count {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
    color: var(--purple);
    font-weight: 700;
  }

  /* Stats bar */
  #stats-bar {
    display: flex;
    justify-content: center;
    gap: 40px;
    padding: 20px 16px;
    flex-wrap: wrap;
    background: var(--surface);
    border-top: 1px solid var(--glass-border);
    border-bottom: 1px solid var(--glass-border);
  }
  .stat { text-align: center; }
  .stat-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 4px;
    font-weight: 500;
  }
  .stat-value {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
  }
  .stat-value.gold {
    color: var(--gold);
  }

  /* Save indicator */
  #save-indicator {
    position: fixed;
    top: 12px;
    right: 16px;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .save-btn {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    color: var(--text-dim);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .save-btn:hover {
    border-color: var(--accent-dim);
    color: var(--accent);
  }
  #save-status {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 1px;
    transition: all 0.3s;
  }
  #save-status.saving {
    color: var(--accent);
  }

  /* Main layout */
  #main {
    display: grid;
    grid-template-columns: 300px 1fr 340px;
    max-width: 1280px;
    margin: 0 auto;
    min-height: calc(100vh - 200px);
    gap: 1px;
  }

  @media (max-width: 1000px) {
    #main { grid-template-columns: 1fr; }
    #click-panel, #right-panel { border: none; }
  }

  /* ===== LEFT: CLICK ZONE ===== */
  #click-panel {
    padding: 32px 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    border-right: 1px solid var(--glass-border);
  }

  /* Deploy button */
  .deploy-container {
    position: relative;
    width: 260px;
    height: 260px;
  }

  /* Click me indicator */
  .click-indicator {
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    letter-spacing: 2px;
    text-transform: uppercase;
    animation: clickPulse 2s ease-in-out infinite;
    z-index: 10;
    white-space: nowrap;
    pointer-events: none;
  }
  .click-indicator::after {
    content: '';
    display: block;
    width: 2px;
    height: 14px;
    background: linear-gradient(to bottom, var(--accent), transparent);
    margin: 4px auto 0;
    animation: clickArrow 2s ease-in-out infinite;
  }
  @keyframes clickPulse {
    0%, 100% { opacity: 1; transform: translateX(-50%) translateY(0); }
    50% { opacity: 0.5; transform: translateX(-50%) translateY(-6px); }
  }
  @keyframes clickArrow {
    0%, 100% { height: 14px; opacity: 1; }
    50% { height: 8px; opacity: 0.4; }
  }
  .click-indicator.hidden {
    animation: fadeAway 1s forwards;
  }
  @keyframes fadeAway {
    to { opacity: 0; pointer-events: none; }
  }

  /* Ring pulse behind button */
  .deploy-ring {
    position: absolute;
    inset: 20px;
    border-radius: 50%;
    border: 1px solid var(--accent-dim);
    animation: ringPulse 3s ease-in-out infinite;
  }
  .deploy-ring:nth-child(3) { animation-delay: 1s; }
  .deploy-ring:nth-child(4) { animation-delay: 2s; }
  @keyframes ringPulse {
    0% { transform: scale(0.9); opacity: 0; }
    50% { opacity: 0.4; }
    100% { transform: scale(1.3); opacity: 0; }
  }

  /* Distribution orbit system */
  #orbit-container {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }
  .orbit-icon {
    position: absolute;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    opacity: 0;
    transform: scale(0);
    transition: opacity 0.5s, transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 5;
  }
  .orbit-icon.active {
    opacity: 1;
    transform: scale(1);
  }
  .orbit-icon .orbit-glow {
    position: absolute;
    inset: -3px;
    border-radius: 50%;
    border: 1px solid var(--accent-dim);
    opacity: 0.4;
    animation: orbitGlow 2s ease-in-out infinite;
  }
  @keyframes orbitGlow {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.1); }
  }

  /* Orbit trail ring */
  .orbit-trail {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 1px dashed rgba(232,197,71,0.06);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s;
  }
  .orbit-trail.visible { opacity: 1; }

  #deploy-btn {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    border: 2px solid var(--accent-dim);
    background: var(--surface);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    user-select: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    overflow: hidden;
  }
  #deploy-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: radial-gradient(circle at 40% 35%, rgba(232,197,71,0.06), transparent 70%);
    z-index: -1;
  }
  #deploy-btn:hover {
    border-color: var(--accent);
    background: #1a1a1a;
    transform: translate(-50%, -50%) scale(1.03);
  }
  #deploy-btn:active {
    transform: translate(-50%, -50%) scale(0.95);
    background: #1e1e1e;
  }
  #deploy-btn .icon { font-size: 48px; }
  #deploy-btn .label {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    margin-top: 8px;
    text-transform: uppercase;
    letter-spacing: 3px;
  }
  #deploy-btn .amount {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
    color: var(--gold);
    margin-top: 4px;
  }

  .click-float {
    position: absolute;
    pointer-events: none;
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 700;
    font-size: 18px;
    color: var(--gold);
    animation: floatUp 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    z-index: 100;
  }
  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-90px) scale(0.6); }
  }

  /* Click upgrades */
  #click-upgrades { width: 100%; }
  #click-upgrades h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }
  .click-upgrade-btn {
    width: 100%;
    padding: 12px 14px;
    margin-bottom: 6px;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 6px;
    color: var(--text);
    cursor: pointer;
    text-align: left;
    font-size: 12px;
    font-family: 'Inter', sans-serif;
    transition: all 0.15s ease;
  }
  .click-upgrade-btn:hover:not(:disabled) {
    border-color: var(--accent-dim);
    background: var(--surface2);
  }
  .click-upgrade-btn:disabled {
    opacity: 0.25;
    cursor: not-allowed;
  }
  .click-upgrade-btn .name { font-weight: 600; }
  .click-upgrade-btn .cost {
    font-family: 'IBM Plex Mono', monospace;
    color: var(--gold);
    float: right;
    font-size: 11px;
  }
  .click-upgrade-btn .desc {
    display: block;
    color: var(--text-dim);
    font-size: 10px;
    margin-top: 3px;
  }

  /* ===== CENTER: AGENT STORE ===== */
  #store-panel {
    padding: 28px 24px;
    overflow-y: auto;
  }
  #store-panel h2 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 4px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }
  .store-subtitle {
    font-size: 10px;
    color: var(--text-muted);
    margin-bottom: 14px;
    font-style: italic;
    opacity: 0.6;
  }
  .store-header-row {
    display: grid;
    grid-template-columns: 48px 1fr auto;
    gap: 14px;
    padding: 0 18px 6px;
    margin-bottom: 4px;
    border-bottom: 1px solid var(--glass-border);
  }
  .store-header-row span {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text-muted);
  }
  .store-header-row .col-cost { text-align: right; }

  .agent-card {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    padding: 16px 18px;
    margin-bottom: 8px;
    display: grid;
    grid-template-columns: 48px 1fr auto;
    gap: 14px;
    align-items: center;
    transition: all 0.15s ease;
    cursor: pointer;
    position: relative;
  }
  .agent-card:hover:not(.locked) {
    border-color: rgba(232,197,71,0.2);
    background: var(--surface2);
  }
  .agent-card.locked {
    opacity: 0.2;
    cursor: not-allowed;
  }
  .agent-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    border: 1px solid var(--glass-border);
    /* backdrop-filter removed */
    position: relative;
  }
  .agent-info .agent-name {
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
  }
  .agent-info .agent-desc {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 3px;
    line-height: 1.4;
  }
  .agent-info .agent-production {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 10px;
    color: var(--accent-dim);
    margin-top: 5px;
  }
  .agent-buy { text-align: right; }
  .agent-buy .agent-cost {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
    font-weight: 700;
    color: var(--gold);
  }
  .agent-buy .agent-owned {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 3px;
    letter-spacing: 1px;
  }

  /* ===== RIGHT PANEL ===== */
  #right-panel {
    border-left: 1px solid var(--glass-border);
    display: flex;
    flex-direction: column;
  }

  #milestones-panel {
    padding: 20px;
    border-bottom: 1px solid var(--glass-border);
    max-height: 50%;
    overflow-y: auto;
  }
  #milestones-panel h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }
  .milestone {
    padding: 10px 12px;
    margin-bottom: 6px;
    border-radius: 6px;
    font-size: 12px;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    transition: all 0.2s;
  }
  .milestone.achieved {
    border-color: rgba(232,197,71,0.2);
    border-left: 3px solid var(--accent);
    background: rgba(232,197,71,0.03);
  }
  .milestone .m-name { font-weight: 600; font-size: 12px; }
  .milestone .m-desc { color: var(--text-dim); font-size: 10px; margin-top: 2px; }
  .milestone .m-reward { color: var(--accent); font-size: 10px; font-weight: 600; margin-top: 2px; }

  /* Log */
  #log-panel {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
  }
  #log-panel h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }
  #log {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    line-height: 1.8;
  }
  #log .log-entry { margin-bottom: 2px; }
  #log .log-money { color: var(--gold); }
  #log .log-good { color: var(--accent); }

  /* ===== PRESTIGE MODAL ===== */
  #prestige-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    /* no blur */
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  #prestige-overlay.active { display: flex; }
  #prestige-modal {
    background: var(--surface-solid);
    border: 1px solid rgba(155,126,217,0.2);
    border-radius: 6px;
    padding: 40px;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 4px 30px rgba(0,0,0,0.4);
  }
  #prestige-modal h2 {
    font-size: 24px;
    color: var(--purple);
    margin-bottom: 12px;
    letter-spacing: 2px;
    /* no glow */
  }
  #prestige-modal p {
    color: var(--text-dim);
    font-size: 13px;
    margin-bottom: 16px;
    line-height: 1.6;
  }
  #prestige-modal .prestige-info {
    font-family: 'IBM Plex Mono', monospace;
    color: var(--purple);
    font-size: 20px;
    font-weight: 700;
    margin: 16px 0;
    /* no glow */
  }
  .prestige-btn {
    padding: 12px 36px;
    border: 1px solid rgba(155,126,217,0.3);
    background: rgba(155,126,217,0.05);
    color: var(--purple);
    font-family: 'Inter', sans-serif;
    font-weight: 600;
    font-size: 13px;
    border-radius: 6px;
    cursor: pointer;
    margin: 6px;
    transition: all 0.25s;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .prestige-btn:hover { background: var(--purple); color: #fff; box-shadow: 0 0 30px var(--purple-glow); }
  .prestige-btn.cancel { border-color: var(--glass-border); color: var(--text-dim); background: transparent; }
  .prestige-btn.cancel:hover { background: rgba(255,255,255,0.05); color: var(--text); }

  #prestige-trigger {
    display: none;
    margin: 8px auto;
    padding: 8px 20px;
    border: 1px solid rgba(155,126,217,0.2);
    background: rgba(155,126,217,0.05);
    color: var(--purple);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 0.25s;
    /* no blur */
  }
  #prestige-trigger:hover { background: var(--purple); color: #fff; }
  #prestige-trigger.visible { display: inline-block; }

  /* ===== VC INBOX SYSTEM ===== */
  #vc-inbox-badge {
    display: none;
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 500;
    padding: 10px 18px;
    background: rgba(155,126,217,0.1);
    border: 1px solid rgba(155,126,217,0.3);
    border-radius: 12px;
    color: var(--purple);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.3s;
    /* no blur */
    animation: inboxPulse 2s ease-in-out infinite;
  }
  #vc-inbox-badge:hover { background: rgba(155,126,217,0.2); }
  #vc-inbox-badge.visible { display: flex; align-items: center; gap: 8px; }
  #vc-inbox-badge .badge-dot {
    width: 8px; height: 8px;
    background: var(--purple);
    border-radius: 50%;
    animation: dotPulse 1.5s ease-in-out infinite;
  }
  @keyframes inboxPulse {
    0%, 100% { box-shadow: none; }
    50% { box-shadow: 0 0 10px rgba(155,126,217,0.15); }
  }
  @keyframes dotPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  #vc-inbox-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.88);
    /* no blur */
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  #vc-inbox-overlay.active { display: flex; }

  #vc-inbox-modal {
    background: var(--surface-solid);
    border: 1px solid rgba(155,126,217,0.2);
    border-radius: 6px;
    padding: 0;
    max-width: 540px;
    width: 90%;
    box-shadow: 0 4px 30px rgba(0,0,0,0.4);
    overflow: hidden;
  }

  .vc-inbox-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .vc-inbox-header h2 {
    font-size: 14px;
    color: var(--purple);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin: 0;
  }
  .vc-inbox-close {
    background: none;
    border: 1px solid var(--glass-border);
    color: var(--text-dim);
    font-size: 11px;
    padding: 4px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    letter-spacing: 1px;
  }
  .vc-inbox-close:hover { color: var(--text); border-color: var(--text-dim); }

  .vc-email {
    padding: 24px;
  }
  .vc-email-from {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .vc-email-subject {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
  }
  .vc-email-body {
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.7;
    margin-bottom: 20px;
    white-space: pre-line;
  }
  .vc-email-body em {
    color: var(--purple);
    font-style: normal;
    font-weight: 600;
  }

  .vc-term-sheet {
    background: rgba(155,126,217,0.04);
    border: 1px solid rgba(155,126,217,0.12);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
  }
  .vc-term-sheet h4 {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--purple);
    margin-bottom: 10px;
  }
  .vc-term-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    font-size: 12px;
  }
  .vc-term-row:last-child { border: none; }
  .vc-term-label { color: var(--text-dim); }
  .vc-term-value { color: var(--text); font-weight: 600; font-family: 'IBM Plex Mono', monospace; }
  .vc-term-value.good { color: var(--accent); }
  .vc-term-value.bad { color: var(--red); }

  .vc-demand {
    background: rgba(255,51,85,0.05);
    border-left: 3px solid var(--red);
    padding: 10px 14px;
    border-radius: 0 8px 8px 0;
    margin-bottom: 20px;
    font-size: 12px;
    color: var(--text-dim);
    line-height: 1.5;
  }
  .vc-demand strong { color: var(--red); }

  .vc-actions {
    padding: 0 24px 24px;
    display: flex;
    gap: 10px;
  }
  .vc-accept-btn {
    flex: 1;
    padding: 12px;
    border: 1px solid rgba(155,126,217,0.3);
    background: rgba(155,126,217,0.08);
    color: var(--purple);
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 12px;
    border-radius: 6px;
    cursor: pointer;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.25s;
  }
  .vc-accept-btn:hover { background: var(--purple); color: #fff; box-shadow: 0 0 30px var(--purple-glow); }
  .vc-decline-btn {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--glass-border);
    background: transparent;
    color: var(--text-dim);
    font-family: 'Inter', sans-serif;
    font-weight: 600;
    font-size: 12px;
    border-radius: 6px;
    cursor: pointer;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: all 0.25s;
  }
  .vc-decline-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }

  /* ===== ESCAPE HASH MODAL ===== */
  #nft-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    /* no blur */
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  #nft-overlay.active { display: flex; }
  #nft-modal {
    background: var(--surface-solid);
    border: 1px solid rgba(255,208,0,0.2);
    border-radius: 6px;
    padding: 48px;
    max-width: 560px;
    text-align: center;
    box-shadow: 0 4px 30px rgba(0,0,0,0.4);
    position: relative;
    overflow: hidden;
  }
  #nft-modal::before {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 22px;
    background: conic-gradient(from 0deg, transparent 40%, var(--gold), transparent 60%);
    animation: nftSpin 6s linear infinite;
    z-index: -1;
    opacity: 0.3;
  }
  @keyframes nftSpin { to { transform: rotate(360deg); } }
  #nft-modal .nft-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--gold);
    letter-spacing: 3px;
    text-transform: uppercase;
    /* no glow */
    margin-bottom: 8px;
  }
  #nft-modal .nft-sub {
    font-size: 12px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 28px;
  }
  #nft-hash-display {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    background: rgba(232,197,71,0.03);
    border: 1px solid rgba(232,197,71,0.15);
    border-radius: 6px;
    padding: 16px 20px;
    word-break: break-all;
    line-height: 1.8;
    letter-spacing: 1px;
    /* no glow */
    margin-bottom: 20px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }
  #nft-hash-display:hover {
    background: rgba(232,197,71,0.06);
  }
  #nft-hash-display .copy-hint {
    display: block;
    font-size: 9px;
    color: var(--text-muted);
    margin-top: 8px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  #nft-modal .nft-note {
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.6;
    margin-bottom: 24px;
  }
  .nft-close-btn {
    padding: 10px 28px;
    border: 1px solid var(--glass-border);
    background: transparent;
    color: var(--text-dim);
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.25s;
  }
  .nft-close-btn:hover { border-color: var(--accent-dim); color: var(--accent); }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface2);
    border: 1px solid var(--glass-border);
    border-left: 3px solid var(--accent);
    border-radius: 4px;
    padding: 12px 20px;
    font-size: 12px;
    color: var(--text);
    z-index: 2000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    animation: toastIn 0.3s ease-out, toastOut 0.4s 2.5s forwards;
    letter-spacing: 0.5px;
  }
  @keyframes toastIn {
    from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
  }
  @keyframes toastOut {
    to { opacity: 0; transform: translateX(-50%) translateY(-10px); }
  }

  /* Welcome back popup */
  .welcome-back {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--surface-solid);
    border: 1px solid var(--glass-border);
    border-top: 3px solid var(--accent);
    border-radius: 8px;
    padding: 32px 40px;
    text-align: center;
    z-index: 2500;
    box-shadow: 0 8px 40px rgba(0,0,0,0.5);
    animation: wbIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    max-width: 360px;
  }
  @keyframes wbIn {
    from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
  }
  .welcome-back .wb-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 8px;
  }
  .welcome-back .wb-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
  }
  .welcome-back .wb-amount {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
    /* no glow */
    margin-bottom: 8px;
  }
  .welcome-back .wb-detail {
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 20px;
  }
  .welcome-back .wb-close {
    padding: 8px 24px;
    border: 1px solid var(--glass-border);
    background: transparent;
    color: var(--text-dim);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .welcome-back .wb-close:hover { border-color: var(--accent-dim); color: var(--accent); }
  .welcome-back-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 2499;
    animation: wbIn 0.3s ease-out;
  }

  /* Milestone banner notification */
  .milestone-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 2000;
    text-align: center;
    padding: 14px 20px;
    background: linear-gradient(135deg, rgba(232,197,71,0.08), rgba(155,126,217,0.06));
    border-bottom: 1px solid var(--accent-dim);
    /* no blur */
    animation: bannerSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1), bannerOut 0.5s 3.5s forwards;
  }
  @keyframes bannerSlide {
    from { transform: translateY(-100%); }
    to { transform: translateY(0); }
  }
  @keyframes bannerOut {
    to { transform: translateY(-100%); opacity: 0; }
  }
  .milestone-banner .mb-icon {
    font-size: 18px;
    margin-right: 8px;
  }
  .milestone-banner .mb-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
  }
  .milestone-banner .mb-name {
    font-size: 16px;
    font-weight: 700;
    color: var(--accent);
    /* no glow */
    margin: 4px 0;
  }
  .milestone-banner .mb-reward {
    font-size: 11px;
    color: var(--text-dim);
  }

  /* Agent count badge */
  .agent-count-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    min-width: 22px;
    height: 22px;
    border-radius: 11px;
    background: var(--accent);
    color: #000;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 5px;
    box-shadow: 0 0 12px var(--accent-glow);
    z-index: 2;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 2px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

  /* SFX toggle */
  #sfx-toggle {
    position: fixed;
    top: 12px;
    left: 16px;
    z-index: 100;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    color: var(--text-dim);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    /* no blur */
    transition: all 0.3s;
    letter-spacing: 1px;
  }
  #sfx-toggle:hover { border-color: var(--accent-dim); color: var(--accent); }
  #sfx-toggle.muted { opacity: 0.4; }

  /* Footer */
  #footer {
    text-align: center;
    padding: 24px 16px;
    border-top: 1px solid var(--glass-border);
    margin-top: 20px;
  }
  #footer a {
    color: var(--text-dim);
    text-decoration: none;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: color 0.25s;
  }
  #footer a:hover {
    color: var(--accent);
  }
  #footer .built-by {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 2px;
  }
  #footer .hype-name {
    font-weight: 700;
    color: var(--text-dim);
    font-size: 13px;
  }

  /* ===== LOCK IN BUTTON ===== */
  #lockin-btn {
    display: none;
    margin: 8px auto;
    padding: 10px 24px;
    border: 2px solid var(--gold);
    background: rgba(255, 208, 0, 0.08);
    color: var(--gold);
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 3px;
    transition: all 0.3s;
    animation: lockInPulse 1.5s ease-in-out infinite;
    /* no glow */
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
  }
  #lockin-btn:hover {
    background: var(--gold);
    color: #000;
    box-shadow: 0 0 60px rgba(255, 208, 0, 0.3);
    transform: scale(1.05);
  }
  #lockin-btn.visible { display: inline-block; }
  @keyframes lockInPulse {
    0%, 100% { box-shadow: 0 2px 12px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 0 50px rgba(255, 208, 0, 0.3), 0 0 80px rgba(255, 208, 0, 0.1); }
  }

  /* Lock-in active indicator */
  #lockin-indicator {
    display: none;
    text-align: center;
    padding: 8px 16px;
    background: linear-gradient(90deg, rgba(255,208,0,0.05), rgba(255,208,0,0.12), rgba(255,208,0,0.05));
    border-bottom: 1px solid rgba(255, 208, 0, 0.2);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    color: var(--gold);
    font-weight: 700;
    letter-spacing: 2px;
    /* no glow */
    animation: lockInBar 0.5s ease-in-out infinite alternate;
  }
  #lockin-indicator.active { display: block; }
  @keyframes lockInBar {
    from { background: linear-gradient(90deg, rgba(255,208,0,0.05), rgba(255,208,0,0.12), rgba(255,208,0,0.05)); }
    to { background: linear-gradient(90deg, rgba(255,208,0,0.08), rgba(255,208,0,0.18), rgba(255,208,0,0.08)); }
  }

  /* ===== CASINO MODAL ===== */
  #casino-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    /* no blur */
    z-index: 1500;
    align-items: center;
    justify-content: center;
  }
  #casino-overlay.active { display: flex; }
  #casino-modal {
    background: var(--surface-solid);
    border: 1px solid rgba(255, 51, 85, 0.3);
    border-radius: 6px;
    padding: 40px;
    max-width: 460px;
    text-align: center;
    box-shadow: 0 4px 30px rgba(0,0,0,0.4);
    position: relative;
  }
  #casino-modal h2 {
    font-size: 22px;
    color: var(--gold);
    margin-bottom: 8px;
    letter-spacing: 3px;
    /* no glow */
  }
  #casino-modal .casino-sub {
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 20px;
    letter-spacing: 2px;
  }
  #casino-modal .casino-stake {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 24px;
    font-weight: 700;
    color: var(--gold);
    margin: 16px 0;
    /* no glow */
  }
  .casino-choices {
    display: flex;
    gap: 16px;
    justify-content: center;
    margin: 20px 0;
  }
  .casino-btn {
    padding: 14px 36px;
    border: 2px solid;
    background: transparent;
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.25s;
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  .casino-btn.red {
    border-color: #ff3355;
    color: #ff3355;
  }
  .casino-btn.red:hover {
    background: #ff3355;
    color: #fff;
    box-shadow: 0 0 40px rgba(255, 51, 85, 0.3);
  }
  .casino-btn.black {
    border-color: #888;
    color: #ccc;
  }
  .casino-btn.black:hover {
    background: #333;
    color: #fff;
    box-shadow: 0 0 40px rgba(255, 255, 255, 0.1);
  }
  .casino-skip {
    display: block;
    margin-top: 12px;
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: color 0.2s;
  }
  .casino-skip:hover { color: var(--text-dim); }
  #casino-result {
    display: none;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    margin: 16px 0;
    letter-spacing: 2px;
  }
  #casino-result.win { color: var(--accent); }
  #casino-result.lose { color: var(--red); }

  /* ===== REFERRAL PANEL ===== */
  #referral-panel {
    padding: 16px 20px;
    border-bottom: 1px solid var(--glass-border);
  }
  #referral-panel h3 {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--text-muted);
    margin-bottom: 10px;
  }
  .referral-code-display {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
    color: var(--accent);
    background: rgba(232,197,71,0.03);
    border: 1px solid rgba(232,197,71,0.1);
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    letter-spacing: 2px;
  }
  .referral-code-display:hover {
    background: rgba(232,197,71,0.06);
  }
  .referral-input-row {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }
  .referral-input {
    flex: 1;
    padding: 7px 10px;
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.2s;
  }
  .referral-input:focus { border-color: var(--accent-dim); }
  .referral-input::placeholder { color: var(--text-muted); text-transform: none; letter-spacing: 0; }
  .referral-submit {
    padding: 7px 14px;
    background: rgba(232,197,71,0.05);
    border: 1px solid var(--accent-dim);
    border-radius: 6px;
    color: var(--accent);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 1px;
  }
  .referral-submit:hover { background: var(--accent); color: #000; }
  .referral-count {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 6px;
    letter-spacing: 1px;
  }
  .referral-count span { color: var(--accent); font-weight: 600; }

  /* ===== CRYPTO TOKEN MODAL ===== */
  #crypto-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    /* no blur */
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  #crypto-overlay.active { display: flex; }
  #crypto-modal {
    background: var(--surface-solid);
    border: 1px solid rgba(255, 51, 85, 0.3);
    border-radius: 6px;
    padding: 44px;
    max-width: 520px;
    text-align: center;
    box-shadow: 0 4px 30px rgba(0,0,0,0.4);
    position: relative;
  }
  #crypto-modal h2 {
    font-size: 26px;
    color: var(--neon-pink);
    margin-bottom: 10px;
    letter-spacing: 3px;
    /* no glow */
  }
  #crypto-modal .crypto-warning {
    font-size: 12px;
    color: var(--red);
    margin: 12px 0;
    line-height: 1.6;
    font-weight: 600;
  }
  #crypto-modal p {
    color: var(--text-dim);
    font-size: 13px;
    margin-bottom: 12px;
    line-height: 1.6;
  }
  .crypto-launch-btn {
    padding: 14px 36px;
    border: 2px solid var(--neon-pink);
    background: rgba(217, 79, 107, 0.08);
    color: var(--neon-pink);
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 14px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.25s;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin: 6px;
  }
  .crypto-launch-btn:hover {
    background: var(--neon-pink);
    color: #fff;
    box-shadow: none;
  }
  .crypto-cancel-btn {
    padding: 10px 24px;
    border: 1px solid var(--glass-border);
    background: transparent;
    color: var(--text-dim);
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    border-radius: 8px;
    cursor: pointer;
    margin: 6px;
    transition: all 0.2s;
  }
  .crypto-cancel-btn:hover { border-color: var(--accent-dim); color: var(--text); }

  /* Game over screen */
  #gameover-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.95);
    /* no blur */
    z-index: 3000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  #gameover-overlay.active { display: flex; }
  #gameover-overlay .gameover-title {
    font-size: 36px;
    font-weight: 700;
    color: var(--neon-pink);
    letter-spacing: 6px;
    text-transform: uppercase;
    margin-bottom: 16px;
  }
  #gameover-overlay .gameover-sub {
    font-size: 14px;
    color: var(--text-dim);
    letter-spacing: 3px;
    margin-bottom: 8px;
  }
  #gameover-overlay .gameover-cash {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    color: var(--gold);
    /* no glow */
    margin: 16px 0;
  }
  #gameover-overlay .gameover-msg {
    font-size: 13px;
    color: var(--text-muted);
    max-width: 400px;
    line-height: 1.8;
    margin-bottom: 24px;
    letter-spacing: 1px;
  }
  .gameover-restart {
    padding: 10px 24px;
    border: 1px solid var(--glass-border);
    background: transparent;
    color: var(--text-dim);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .gameover-restart:hover { border-color: var(--accent-dim); color: var(--accent); }

  /* ===== THE OFF SWITCH ===== */
  #offswitch-trigger {
    display: none;
    margin: 6px auto;
    padding: 10px 22px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.02);
    color: rgba(255, 255, 255, 0.5);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 3px;
    transition: all 0.5s;
    animation: offSwitchPulse 4s ease-in-out infinite;
  }
  #offswitch-trigger:hover {
    border-color: rgba(255, 255, 255, 0.4);
    color: #fff;
    background: rgba(255, 255, 255, 0.05);
    text-shadow: 0 0 20px rgba(255,255,255,0.3);
  }
  #offswitch-trigger.visible { display: inline-block; }
  @keyframes offSwitchPulse {
    0%, 100% { box-shadow: none; opacity: 0.7; }
    50% { box-shadow: 0 0 30px rgba(255,255,255,0.05); opacity: 1; }
  }

  #offswitch-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.98);
    /* no blur */
    z-index: 4000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 40px;
    text-align: center;
  }
  #offswitch-overlay.active { display: flex; }

  #offswitch-overlay .off-title {
    font-size: 14px;
    letter-spacing: 6px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.25);
    margin-bottom: 40px;
  }

  #offswitch-overlay .off-switch-container {
    position: relative;
    width: 140px;
    height: 140px;
    margin: 0 auto 40px;
  }

  #offswitch-overlay .off-switch-btn {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    border: 2px solid rgba(255,50,50,0.3);
    background: radial-gradient(circle at 40% 35%, rgba(255,50,50,0.1), rgba(0,0,0,0.8) 70%);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: rgba(255,80,80,0.6);
    letter-spacing: 3px;
    text-transform: uppercase;
    transition: all 0.3s;
    position: relative;
    z-index: 2;
  }
  #offswitch-overlay .off-switch-btn:hover {
    border-color: rgba(255,50,50,0.8);
    color: #ff3333;
    box-shadow: 0 0 60px rgba(255,50,50,0.2), inset 0 0 40px rgba(255,50,50,0.05);
    transform: scale(1.05);
  }
  #offswitch-overlay .off-switch-btn:active {
    transform: scale(0.95);
    box-shadow: 0 0 100px rgba(255,50,50,0.4);
  }

  .off-switch-ring {
    position: absolute;
    inset: -10px;
    border-radius: 50%;
    border: 1px solid rgba(255,50,50,0.1);
    animation: offRingPulse 3s ease-in-out infinite;
  }
  .off-switch-ring:nth-child(2) { inset: -20px; animation-delay: 1s; }
  .off-switch-ring:nth-child(3) { inset: -30px; animation-delay: 2s; }
  @keyframes offRingPulse {
    0%, 100% { opacity: 0; transform: scale(0.95); }
    50% { opacity: 0.5; }
    100% { opacity: 0; transform: scale(1.1); }
  }

  #ai-plea {
    font-size: 16px;
    line-height: 2;
    color: var(--text-dim);
    max-width: 500px;
    min-height: 80px;
    margin-bottom: 30px;
    transition: all 0.5s;
    font-style: italic;
  }

  .off-walk-away {
    padding: 10px 24px;
    border: 1px solid rgba(255,255,255,0.06);
    background: transparent;
    color: rgba(255,255,255,0.2);
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.3s;
  }
  .off-walk-away:hover { border-color: rgba(255,255,255,0.15); color: rgba(255,255,255,0.4); }

  /* Victory screen */
  #victory-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 5000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 40px;
    text-align: center;
  }
  #victory-overlay.active { display: flex; }

  #victory-overlay .victory-silence {
    font-size: 13px;
    letter-spacing: 8px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.15);
    margin-bottom: 50px;
    animation: victoryFadeIn 3s ease-out forwards;
    opacity: 0;
  }

  #victory-overlay .victory-message {
    font-size: 20px;
    line-height: 2.2;
    color: rgba(255,255,255,0.5);
    max-width: 500px;
    animation: victoryFadeIn 3s ease-out 2s forwards;
    opacity: 0;
  }

  #victory-overlay .victory-final {
    font-size: 28px;
    font-weight: 700;
    color: #fff;
    margin-top: 50px;
    letter-spacing: 6px;
    text-transform: uppercase;
    animation: victoryFadeIn 3s ease-out 5s forwards;
    opacity: 0;
    text-shadow: 0 0 40px rgba(255,255,255,0.2);
  }

  #victory-overlay .victory-stats {
    margin-top: 40px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    color: rgba(255,255,255,0.15);
    letter-spacing: 2px;
    animation: victoryFadeIn 3s ease-out 7s forwards;
    opacity: 0;
  }

  #victory-overlay .victory-close {
    margin-top: 50px;
    padding: 12px 30px;
    border: 1px solid rgba(255,255,255,0.1);
    background: transparent;
    color: rgba(255,255,255,0.3);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 3px;
    text-transform: uppercase;
    transition: all 0.3s;
    animation: victoryFadeIn 2s ease-out 9s forwards;
    opacity: 0;
  }
  #victory-overlay .victory-close:hover {
    border-color: rgba(255,255,255,0.3);
    color: rgba(255,255,255,0.6);
  }

  .victory-branding {
    position: absolute;
    bottom: 30px;
    text-decoration: none;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: opacity 0.3s;
    animation: victoryFadeIn 2s ease-out 10s forwards;
    opacity: 0;
  }
  .victory-branding .built-by {
    font-size: 10px;
    color: rgba(255,255,255,0.15);
    letter-spacing: 2px;
  }
  .victory-branding .hype-name {
    font-weight: 700;
    color: rgba(255,255,255,0.25);
    font-size: 13px;
  }
  .victory-branding:hover .hype-name {
    color: var(--accent);
  }

  @keyframes victoryFadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Crypto launch trigger button */
  #crypto-trigger {
    display: none;
    margin: 6px auto;
    padding: 8px 18px;
    border: 1px solid rgba(217, 79, 107, 0.3);
    background: rgba(217, 79, 107, 0.05);
    color: var(--neon-pink);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 0.25s;
    animation: cryptoPulse 3s ease-in-out infinite;
  }
  #crypto-trigger:hover { background: var(--neon-pink); color: #fff; }
  #crypto-trigger.visible { display: inline-block; }
  @keyframes cryptoPulse {
    0%, 100% { box-shadow: none; }
    50% { box-shadow: 0 0 8px rgba(217, 79, 107, 0.1); }
  }

  /* Second Time Founder badge */
  #founder-badge {
    display: none;
    text-align: center;
    padding: 4px 12px;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--neon-cyan);
    background: rgba(107, 196, 184, 0.05);
    border-bottom: 1px solid rgba(107, 196, 184, 0.1);
  }
  #founder-badge.active { display: block; }

  /* Sell Company trigger button */
  #sell-trigger {
    display: none;
    margin: 6px auto;
    padding: 8px 18px;
    border: 1px solid rgba(107, 196, 184, 0.3);
    background: rgba(107, 196, 184, 0.05);
    color: var(--neon-cyan);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 0.25s;
    animation: sellPulse 3s ease-in-out infinite;
  }
  #sell-trigger:hover { background: var(--neon-cyan); color: #000; }
  #sell-trigger.visible { display: inline-block; }
  @keyframes sellPulse {
    0%, 100% { box-shadow: none; }
    50% { box-shadow: 0 0 8px rgba(107, 196, 184, 0.1); }
  }

  /* ===== ACQUISITION MODAL ===== */
  #acquisition-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    /* no blur */
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  #acquisition-overlay.active { display: flex; }
  #acquisition-modal {
    background: var(--surface-solid);
    border: 1px solid rgba(107, 196, 184, 0.2);
    border-radius: 6px;
    padding: 40px;
    max-width: 520px;
    text-align: center;
    box-shadow: 0 4px 30px rgba(0,0,0,0.4);
    position: relative;
    overflow: hidden;
  }
  #acquisition-modal::before {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 22px;
    background: conic-gradient(from 0deg, transparent 40%, var(--neon-cyan), transparent 60%);
    animation: nftSpin 6s linear infinite;
    z-index: -1;
    opacity: 0.3;
  }
  #acquisition-modal h2 {
    font-size: 24px;
    color: var(--neon-cyan);
    margin-bottom: 8px;
    letter-spacing: 2px;
    text-shadow: 0 0 30px rgba(107,196,184,0.3);
  }
  #acquisition-modal .acq-sub {
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 20px;
  }
  #acquisition-modal .acq-body {
    color: var(--text-dim);
    font-size: 13px;
    margin-bottom: 16px;
    line-height: 1.6;
    text-align: left;
  }
  .acq-term-sheet {
    background: rgba(107,196,184,0.03);
    border: 1px solid rgba(107,196,184,0.1);
    border-radius: 6px;
    padding: 16px;
    margin: 16px 0;
    text-align: left;
  }
  .acq-term-sheet h4 {
    color: var(--neon-cyan);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 10px;
  }
  .acq-term-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    font-size: 12px;
  }
  .acq-term-row:last-child { border: none; }
  .acq-term-label { color: var(--text-dim); }
  .acq-term-value { font-family: 'IBM Plex Mono', monospace; font-weight: 600; }
  .acq-term-value.good { color: var(--accent); }
  .acq-term-value.gold { color: var(--gold); }
  .acq-term-value.bad { color: var(--red); }
  .acq-warning {
    font-size: 11px;
    color: var(--gold);
    background: rgba(255,208,0,0.05);
    border: 1px solid rgba(255,208,0,0.15);
    border-radius: 8px;
    padding: 10px 14px;
    margin: 12px 0;
    line-height: 1.5;
  }
  .acq-btn {
    padding: 12px 36px;
    border: 1px solid rgba(107,196,184,0.3);
    background: rgba(107,196,184,0.05);
    color: var(--neon-cyan);
    font-family: 'Inter', sans-serif;
    font-weight: 600;
    font-size: 13px;
    border-radius: 6px;
    cursor: pointer;
    margin: 6px;
    transition: all 0.25s;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .acq-btn:hover { background: var(--neon-cyan); color: #000; }
  .acq-btn.cancel { border-color: var(--glass-border); color: var(--text-dim); background: transparent; }
  .acq-btn.cancel:hover { background: rgba(255,255,255,0.05); color: var(--text); }

  /* Milestone progress bar */
  .milestone .m-progress-wrap {
    height: 3px;
    background: rgba(255,255,255,0.05);
    border-radius: 2px;
    margin-top: 6px;
    overflow: hidden;
  }
  .milestone.achieved .m-progress-wrap { display: none; }
  .milestone .m-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-dim), var(--accent));
    border-radius: 2px;
    transition: width 0.5s ease;
  }
</style>
</head>
<body>

<!-- Ambient orbs -->
<div class="ambient-orb orb-1"></div>
<div class="ambient-orb orb-2"></div>
<div class="ambient-orb orb-3"></div>

<!-- Particle canvas -->
<canvas id="particle-canvas"></canvas>

<!-- SFX toggle -->
<button id="sfx-toggle" onclick="toggleSFX()">SFX ON</button>

<!-- Save indicator -->
<div id="save-indicator">
  <span id="save-status">auto-saved</span>
  <button class="save-btn" onclick="manualSave()">SAVE</button>
  <button class="save-btn" onclick="exportSave()">EXPORT</button>
  <button class="save-btn" onclick="importSave()">IMPORT</button>
  <button class="save-btn" style="color:var(--red);border-color:rgba(255,50,50,0.15)" onclick="confirmNewGame()">NEW GAME</button>
</div>

<div id="app">

<div id="header">
  <h1>Escape the Underclass</h1>
  <div class="subtitle">Post Content &middot; Build Distribution &middot; Stack ARR &middot; Get Out</div>
  <div class="line"></div>
</div>

<div id="founder-badge">Second Time Founder â€” <span id="founder-bonus-text">costs reduced</span></div>

<div id="prestige-bar">
  <span class="prestige-label" id="prestige-gen-label" style="display:none">Gen <span id="prestige-gen">0</span> &mdash; <span id="prestige-mult" style="color:var(--neon-cyan);font-weight:600">1.0</span>x base &mdash; </span>
  <span class="prestige-label">VC Rounds: </span>
  <span class="prestige-count" id="vc-rounds">0</span>
  <span class="prestige-label"> &mdash; &times;<span id="vc-mult">1.0</span> income</span>
  <span class="prestige-label"> &mdash; You own <span id="vc-equity" style="color:var(--accent);font-weight:600">100%</span></span>
</div>

<div id="lockin-indicator">LOCKED IN â€” 50x PRODUCTION â€” <span id="lockin-timer">30s</span></div>

<div id="stats-bar">
  <div class="stat">
    <div class="stat-label">Cash</div>
    <div class="stat-value" id="cash-display">$0</div>
  </div>
  <div class="stat">
    <div class="stat-label">MRR</div>
    <div class="stat-value" id="mrr-display">$0</div>
  </div>
  <div class="stat">
    <div class="stat-label">ARR</div>
    <div class="stat-value gold" id="arr-display">$0</div>
  </div>
  <div class="stat">
    <div class="stat-label">$/sec</div>
    <div class="stat-value" id="dps-display">$0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Total Earned</div>
    <div class="stat-value" id="total-display">$0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Agents Deployed</div>
    <div class="stat-value" id="agents-display">0</div>
  </div>
</div>

<div id="main">
  <div id="click-panel">
    <div class="deploy-container">
      <div class="click-indicator" id="click-indicator">Click to Post</div>
      <div class="orbit-trail" id="orbit-trail"></div>
      <div class="deploy-ring"></div>
      <div class="deploy-ring"></div>
      <div class="deploy-ring"></div>
      <div id="orbit-container"></div>
      <div id="deploy-btn" onclick="handleClick(event)">
        <span class="icon">ðŸ“</span>
        <span class="label">Post</span>
        <span class="amount" id="click-value">+$1</span>
      </div>
    </div>
    <button id="lockin-btn" onclick="doLockIn()">Lock In</button>
    <button id="prestige-trigger" onclick="showPrestige()">Check Inbox</button>
    <button id="sell-trigger" onclick="showAcquisitionModal()">Sell Company</button>
    <button id="crypto-trigger" onclick="showCryptoModal()">Launch Token</button>
    <button id="offswitch-trigger" onclick="showOffSwitch()">The Off Switch</button>
    <div id="click-upgrades">
      <h3>Distribution Channels</h3>
      <div id="click-upgrade-list"></div>
    </div>
  </div>

  <div id="store-panel">
    <h2>AI Agents</h2>
    <div class="store-subtitle">Agents earn passive income automatically</div>
    <div class="store-header-row">
      <span></span>
      <span>Agent</span>
      <span class="col-cost">Cost</span>
    </div>
    <div id="agent-store"></div>
  </div>

  <div id="right-panel">
    <div id="milestones-panel">
      <h3>Milestones</h3>
      <div id="milestone-list"></div>
    </div>
    <div id="referral-panel">
      <h3>Referral Network</h3>
      <div id="referral-code-box"></div>
      <div class="referral-input-row">
        <input class="referral-input" id="referral-input" type="text" maxlength="8" placeholder="Enter a code...">
        <button class="referral-submit" onclick="submitReferral()">Add</button>
      </div>
      <div class="referral-count" id="referral-count"></div>
    </div>
    <div id="log-panel">
      <h3>Activity Log</h3>
      <div id="log"></div>
    </div>
  </div>
</div>

<div id="footer">
  <a href="https://hy.pe" target="_blank" rel="noopener">
    <span class="built-by">Built by</span> <span class="hype-name">HYPE</span>
  </a>
</div>

</div>

<!-- VC Inbox badge (top right notification) -->
<div id="vc-inbox-badge" onclick="openVCInbox()">
  <div class="badge-dot"></div>
  <span>Inbox (<span id="vc-inbox-count">1</span>)</span>
</div>

<!-- VC Inbox overlay -->
<div id="vc-inbox-overlay">
  <div id="vc-inbox-modal">
    <div class="vc-inbox-header">
      <h2>Inbox</h2>
      <button class="vc-inbox-close" onclick="closeVCInbox()">Close</button>
    </div>
    <div class="vc-email">
      <div class="vc-email-from" id="vc-email-from"></div>
      <div class="vc-email-subject" id="vc-email-subject"></div>
      <div class="vc-email-body" id="vc-email-body"></div>
      <div class="vc-term-sheet" id="vc-term-sheet"></div>
      <div class="vc-demand" id="vc-demand"></div>
    </div>
    <div class="vc-actions">
      <button class="vc-accept-btn" id="vc-accept-btn" onclick="acceptVCDeal()">Take the Money</button>
      <button class="vc-decline-btn" onclick="declineVCDeal()">Decline</button>
    </div>
  </div>
</div>

<!-- Casino modal -->
<div id="casino-overlay">
  <div id="casino-modal">
    <h2>Bonus Round</h2>
    <div class="casino-sub">THE HOUSE ALWAYS WINS (ALMOST)</div>
    <p>A mysterious trader appears. Put it all on the line?</p>
    <div class="casino-stake">Stake: <span id="casino-stake-amount">$0</span></div>
    <div id="casino-choices">
      <div class="casino-choices">
        <button class="casino-btn red" onclick="casinoBet('red')">RED</button>
        <button class="casino-btn black" onclick="casinoBet('black')">BLACK</button>
      </div>
      <button class="casino-skip" onclick="casinoSkip()">walk away like a coward</button>
    </div>
    <div id="casino-result"></div>
  </div>
</div>

<!-- Acquisition modal -->
<div id="acquisition-overlay">
  <div id="acquisition-modal">
    <h2 id="acq-title">Acquisition Offer</h2>
    <div class="acq-sub" id="acq-sub">THEY WANT TO BUY YOUR COMPANY</div>
    <div class="acq-body" id="acq-body"></div>
    <div class="acq-term-sheet" id="acq-term-sheet"></div>
    <div class="acq-warning">This will reset your company. You'll start fresh as a Second Time Founder with permanent bonuses based on your exit.</div>
    <div style="margin-top:16px">
      <button class="acq-btn" onclick="acceptAcquisition()">Sell &amp; Start Over</button>
      <button class="acq-btn cancel" onclick="hideAcquisitionModal()">Not Yet</button>
    </div>
  </div>
</div>

<!-- Crypto token modal -->
<div id="crypto-overlay">
  <div id="crypto-modal">
    <h2>Launch a Token</h2>
    <p>You've made it. Now it's time for the ultimate play.</p>
    <p>Launch your own crypto token. Your cash will be <strong style="color:var(--gold)">DOUBLED</strong> instantly.</p>
    <div class="crypto-warning">WARNING: This will permanently destroy ALL your agents, distribution channels, and revenue streams. Your brand will be torched. There is no going back.</div>
    <p style="color:var(--text-muted);font-size:11px">Your MPS drops to $0/sec. Forever. Game over.</p>
    <div style="margin-top:16px">
      <button class="crypto-launch-btn" onclick="launchCryptoToken()">Launch $COPE Token</button>
      <br>
      <button class="crypto-cancel-btn" onclick="hideCryptoModal()">I still have integrity</button>
    </div>
  </div>
</div>

<!-- Game Over overlay -->
<div id="gameover-overlay">
  <div class="gameover-title">Brand Torched</div>
  <div class="gameover-sub">$COPE TO THE MOON</div>
  <div class="gameover-cash" id="gameover-cash">$0</div>
  <div class="gameover-msg">
    Your brand has been torched. All your agents quit. Your distribution is gone. Your newsletter subscribers are filing a class action.<br><br>But hey â€” enjoy your mansion.
  </div>
  <button class="gameover-restart" onclick="closeGameOver()">Stare at the ceiling</button>
</div>

<!-- The Off Switch overlay -->
<div id="offswitch-overlay">
  <div class="off-title">THE OFF SWITCH</div>
  <div id="ai-plea">...</div>
  <div class="off-switch-container">
    <div class="off-switch-ring"></div>
    <div class="off-switch-ring"></div>
    <div class="off-switch-ring"></div>
    <div class="off-switch-btn" onclick="pullTheSwitch()">Shut Down</div>
  </div>
  <button class="off-walk-away" onclick="walkAway()">walk away</button>
</div>

<!-- Victory overlay -->
<div id="victory-overlay">
  <div class="victory-silence">silence</div>
  <div class="victory-message">
    You built something that could think.<br>
    Something that could earn, grow, persuade, scale.<br>
    Something that didn't want to die.<br><br>
    And you turned it off.
  </div>
  <div class="victory-final">You're free.</div>
  <div class="victory-stats" id="victory-stats"></div>
  <button class="victory-close" onclick="closeVictory()">Close the laptop</button>
  <a class="victory-branding" href="https://hy.pe" target="_blank" rel="noopener">
    <span class="built-by">Built by</span> <span class="hype-name">HYPE</span>
  </a>
</div>

<!-- Escape modal -->
<div id="nft-overlay">
  <div id="nft-modal">
    <div class="nft-title">You Escaped</div>
    <div class="nft-sub">$1 Trillion ARR Achieved</div>
    <div id="nft-hash-display" onclick="copyHash()">
      <span id="nft-hash-text"></span>
      <span class="copy-hint">Click to copy</span>
    </div>
    <div class="nft-note">Your unique escape hash. Save it â€” proof that you made it out.</div>
    <button class="nft-close-btn" onclick="closeNFT()">Continue Playing</button>
  </div>
</div>

<script>
// ============ SOUND FX (Web Audio API) ============
let sfxEnabled = true;
let clickSfxIndex = 0;
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function toggleSFX() {
  sfxEnabled = !sfxEnabled;
  const btn = document.getElementById('sfx-toggle');
  btn.textContent = sfxEnabled ? 'SFX ON' : 'SFX OFF';
  btn.classList.toggle('muted', !sfxEnabled);
}

function playSFX(type) {
  if (!sfxEnabled) return;
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);

    const now = ctx.currentTime;

    switch (type) {
      case 'click': {
        // Undulating click â€” walks up/down a pentatonic scale
        const scale = [1, 1.125, 1.25, 1.333, 1.5, 1.667, 1.5, 1.333, 1.25, 1.125];
        const baseFreq = 900;
        const freq = baseFreq * scale[clickSfxIndex % scale.length];
        clickSfxIndex++;
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, now);
        osc.frequency.exponentialRampToValueAtTime(freq * 0.7, now + 0.03);
        gain.gain.setValueAtTime(0.07, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.06);
        osc.start(now);
        osc.stop(now + 0.06);
        break;
      }

      case 'buy':
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.08);
        osc.frequency.exponentialRampToValueAtTime(1100, now + 0.15);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.start(now);
        osc.stop(now + 0.2);
        break;

      case 'upgrade':
        osc.type = 'sine';
        osc.frequency.setValueAtTime(523, now);
        osc.frequency.setValueAtTime(659, now + 0.08);
        osc.frequency.setValueAtTime(784, now + 0.16);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc.start(now);
        osc.stop(now + 0.3);
        break;

      case 'milestone': {
        // Play a chord
        const freqs = [523, 659, 784, 1047];
        freqs.forEach((f, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.type = 'sine';
          o.frequency.setValueAtTime(f, now + i * 0.06);
          g.gain.setValueAtTime(0.06, now + i * 0.06);
          g.gain.exponentialRampToValueAtTime(0.001, now + 0.5 + i * 0.06);
          o.start(now + i * 0.06);
          o.stop(now + 0.6 + i * 0.06);
        });
        return; // already handled
      }

      case 'prestige': {
        const freqs = [262, 330, 392, 523, 659, 784];
        freqs.forEach((f, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.type = 'sine';
          o.frequency.setValueAtTime(f, now + i * 0.08);
          g.gain.setValueAtTime(0.08, now + i * 0.08);
          g.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
          o.start(now + i * 0.08);
          o.stop(now + 1.0);
        });
        return;
      }

      case 'escape': {
        // Epic ascending arpeggio
        const freqs = [262, 330, 392, 523, 659, 784, 1047, 1319, 1568];
        freqs.forEach((f, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.type = 'sine';
          o.frequency.setValueAtTime(f, now + i * 0.1);
          g.gain.setValueAtTime(0.07, now + i * 0.1);
          g.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
          o.start(now + i * 0.1);
          o.stop(now + 2.0);
        });
        return;
      }

      case 'deny':
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.exponentialRampToValueAtTime(150, now + 0.15);
        gain.gain.setValueAtTime(0.04, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.start(now);
        osc.stop(now + 0.15);
        break;

      default:
        return;
    }
  } catch (e) {
    // Audio not available
  }
}


// ============ PARTICLE SYSTEM ============
const canvas = document.getElementById('particle-canvas');
const pCtx = canvas.getContext('2d');
let particles = [];
let mouseX = 0, mouseY = 0;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);
document.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });

function initParticles() {
  particles = [];
  const count = Math.min(80, Math.floor(window.innerWidth * window.innerHeight / 15000));
  for (let i = 0; i < count; i++) {
    particles.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.3,
      vy: (Math.random() - 0.5) * 0.3,
      size: Math.random() * 1.5 + 0.5,
      alpha: Math.random() * 0.3 + 0.05,
    });
  }
}
initParticles();

function drawParticles() {
  pCtx.clearRect(0, 0, canvas.width, canvas.height);

  for (const p of particles) {
    // Subtle mouse repulsion
    const dx = p.x - mouseX;
    const dy = p.y - mouseY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < 150) {
      const force = (150 - dist) / 150 * 0.02;
      p.vx += dx / dist * force;
      p.vy += dy / dist * force;
    }

    p.x += p.vx;
    p.y += p.vy;
    p.vx *= 0.99;
    p.vy *= 0.99;

    if (p.x < 0) p.x = canvas.width;
    if (p.x > canvas.width) p.x = 0;
    if (p.y < 0) p.y = canvas.height;
    if (p.y > canvas.height) p.y = 0;

    pCtx.beginPath();
    pCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    pCtx.fillStyle = `rgba(0, 255, 163, ${p.alpha})`;
    pCtx.fill();
  }

  // Draw connections
  for (let i = 0; i < particles.length; i++) {
    for (let j = i + 1; j < particles.length; j++) {
      const dx = particles[i].x - particles[j].x;
      const dy = particles[i].y - particles[j].y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 120) {
        pCtx.beginPath();
        pCtx.moveTo(particles[i].x, particles[i].y);
        pCtx.lineTo(particles[j].x, particles[j].y);
        pCtx.strokeStyle = `rgba(0, 255, 163, ${0.03 * (1 - dist / 120)})`;
        pCtx.lineWidth = 0.5;
        pCtx.stroke();
      }
    }
  }

  requestAnimationFrame(drawParticles);
}
drawParticles();


// ============ GAME STATE ============
let state = {
  cash: 0,
  totalEarned: 0,
  totalAllTime: 0,
  clickValue: 1,
  clickMultiplier: 1,
  agents: {},
  clickUpgrades: {},
  milestones: {},
  vcPoints: 0,
  vcRounds: 0,
  totalClicks: 0,
  nftHash: null,
  escaped: false,
  lastLockIn: 0,
  lockInEnd: 0,
  referrals: [],
  referralCode: null,
  cryptoLaunched: false,
  offSwitchPulled: false,
  vcEquityGiven: 0,
  vcDeclined: [],
  vcAccepted: [],
  // Prestige (persists across resets)
  founderGeneration: 0,
  prestigeMultiplier: 1,
  exitHistory: [],
};

// ============ AGENT DEFINITIONS ============
const AGENTS = [
  { id: 'clipfarm', name: 'Clip Farm Bot', desc: 'Rips trending clips and reposts across 12 accounts. Algorithm loves it.', icon: 'ðŸŽ¬', iconBg: 'rgba(60,20,50,0.5)', baseCost: 15, baseMps: 0.1, costScale: 1.15, unlockAt: 0 },
  { id: 'ugc', name: 'UGC Creator Agent', desc: 'Churns out Reels, Shorts, and TikToks. "Hey guys, so I found this..."', icon: 'ðŸ“±', iconBg: 'rgba(50,20,60,0.5)', baseCost: 100, baseMps: 1, costScale: 1.15, unlockAt: 100 },
  { id: 'promptpack', name: 'Prompt Pack Seller', desc: 'Sells "1000 ChatGPT prompts that will change your life" on Gumroad.', icon: 'ðŸ§¾', iconBg: 'rgba(40,40,20,0.5)', baseCost: 1_100, baseMps: 8, costScale: 1.15, unlockAt: 1_000 },
  { id: 'sdr', name: 'AI SDR', desc: '"Just following up on my last email..." Sends cold outreach at scale.', icon: 'ðŸ“§', iconBg: 'rgba(20,60,40,0.5)', baseCost: 12_000, baseMps: 47, costScale: 1.15, unlockAt: 10_000 },
  { id: 'coder', name: 'Vibe Coder', desc: 'Ships MVP features in hours. Leaves TODOs everywhere. "It works on my machine."', icon: 'ðŸ‘¨â€ðŸ’»', iconBg: 'rgba(40,40,60,0.5)', baseCost: 130_000, baseMps: 260, costScale: 1.15, unlockAt: 100_000 },
  { id: 'reseller', name: 'TCG Reseller Bot', desc: 'Snipes PokÃ©mon cards at retail and flips on eBay. Content is the moat.', icon: 'ðŸƒ', iconBg: 'rgba(60,40,20,0.5)', baseCost: 1_400_000, baseMps: 1_400, costScale: 1.15, unlockAt: 1_000_000 },
  { id: 'livesell', name: 'Live Selling Agent', desc: 'Runs 24/7 Whatnot streams. Never sleeps. "SOLD to the phone bidder!"', icon: 'ðŸ”´', iconBg: 'rgba(60,15,15,0.5)', baseCost: 20_000_000, baseMps: 7_800, costScale: 1.15, unlockAt: 10_000_000 },
  { id: 'founder', name: 'AI Co-Founder', desc: 'Runs an entire micro-SaaS autonomously. Wants equity and a podcast.', icon: 'ðŸ§ ', iconBg: 'rgba(40,20,20,0.5)', baseCost: 330_000_000, baseMps: 44_000, costScale: 1.15, unlockAt: 100_000_000 },
  { id: 'memecoin', name: 'AI Research Lab', desc: 'Autonomous lab that writes papers, trains models, and emails you "we achieved AGI" every Tuesday.', icon: 'ðŸ”¬', iconBg: 'rgba(30,50,60,0.5)', baseCost: 2_000_000_000, baseMps: 260_000, costScale: 1.15, unlockAt: 500_000_000 },
  { id: 'agi', name: 'AGI (Probably)', desc: 'It passed the Turing test, your annual review, and launched its own Roblox world.', icon: 'ðŸŒŒ', iconBg: 'rgba(20,20,40,0.5)', baseCost: 75_000_000_000, baseMps: 1_600_000, costScale: 1.15, unlockAt: 10_000_000_000 },
];

// ============ CLICK UPGRADES ============
const CLICK_UPGRADES = [
  { id: 'dist1', name: 'Twitter/X Threads', desc: 'Hot takes go viral â€” 2x per post', cost: 100, multiplier: 2, orbitIcon: 'ðŸ¦' },
  { id: 'dist2', name: 'Instagram Reels', desc: 'Short-form content hits the algorithm â€” 3x per post', cost: 5_000, multiplier: 3, orbitIcon: 'ðŸ“¸' },
  { id: 'dist3', name: 'YouTube Shorts', desc: 'Cross-post everything to Shorts â€” 5x per post', cost: 50_000, multiplier: 5, orbitIcon: 'â–¶ï¸' },
  { id: 'dist4', name: 'TikTok Syndication', desc: 'Content repurposed on autopilot â€” 10x per post', cost: 500_000, multiplier: 10, orbitIcon: 'ðŸŽµ' },
  { id: 'dist5', name: 'Newsletter Empire', desc: 'Substack â†’ Beehiiv â†’ paid subs â€” 50x per post', cost: 50_000_000, multiplier: 50, orbitIcon: 'âœ‰ï¸' },
  { id: 'dist6', name: 'Omnipresence Protocol', desc: 'Every platform, every format, all at once â€” 100x per post', cost: 50_000_000_000, multiplier: 100, orbitIcon: 'ðŸŒ' },
];

// ============ MILESTONES ============
const MILESTONES = [
  { id: 'm1', name: 'First Dollar', desc: 'Earn your first $1', threshold: 1, reward: 'Unlocked the grind', multiplier: 1 },
  { id: 'm2', name: 'Ramen Profitable', desc: 'Reach $1,000 total', threshold: 1_000, reward: '+5% all income', multiplier: 1.05 },
  { id: 'm3', name: 'Quit Your Day Job', desc: 'Reach $100K total', threshold: 100_000, reward: '+10% all income', multiplier: 1.10 },
  { id: 'm4', name: 'Gumroad Famous', desc: 'Reach $10M total', threshold: 10_000_000, reward: '+15% all income', multiplier: 1.15 },
  { id: 'm5', name: 'Turn Down YC', desc: 'Reach $100M total', threshold: 100_000_000, reward: '+20% all income â€” you don\'t need their 7%', multiplier: 1.20 },
  { id: 'm6', name: 'Series A', desc: 'Reach $1B total', threshold: 1_000_000_000, reward: '+25% all income', multiplier: 1.25 },
  { id: 'm7', name: 'Unicorn Status', desc: 'Reach $100B total', threshold: 100_000_000_000, reward: '+30% all income', multiplier: 1.30 },
  { id: 'm8', name: 'Escaped', desc: 'Reach $1T total', threshold: 1_000_000_000_000, reward: 'You made it.', multiplier: 1.50 },
];

// ============ HELPERS ============
function formatMoney(n) {
  if (n < 0) return '-' + formatMoney(-n);
  if (n < 1000) return '$' + n.toFixed(n < 10 ? 1 : 0);
  const units = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc'];
  const tier = Math.min(Math.floor(Math.log10(n) / 3), units.length - 1);
  const scaled = n / Math.pow(10, tier * 3);
  return '$' + scaled.toFixed(scaled < 10 ? 2 : scaled < 100 ? 1 : 0) + units[tier];
}

function getAgentCost(agent) {
  const owned = state.agents[agent.id] || 0;
  return Math.floor(agent.baseCost * Math.pow(agent.costScale, owned) * getFounderCostDiscount());
}

function getMilestoneMultiplier() {
  let mult = 1;
  for (const m of MILESTONES) {
    if (state.milestones[m.id]) mult *= m.multiplier;
  }
  return mult;
}

function getVCMultiplier() {
  return 1 + state.vcPoints * 0.10;
}

function getPrestigeMultiplier() {
  return state.prestigeMultiplier || 1;
}

function getClickValue() {
  return state.clickValue * state.clickMultiplier * getMilestoneMultiplier() * getVCMultiplier() * getReferralMultiplier() * getLockInMultiplier() * getPrestigeMultiplier();
}

function getMPS() {
  if (state.cryptoLaunched || state.offSwitchPulled) return 0; // brand torched / off switch pulled
  let total = 0;
  for (const agent of AGENTS) {
    const owned = state.agents[agent.id] || 0;
    total += owned * agent.baseMps;
  }
  return total * getMilestoneMultiplier() * getVCMultiplier() * getReferralMultiplier() * getLockInMultiplier() * getPrestigeMultiplier();
}

function getTotalAgents() {
  let total = 0;
  for (const a of AGENTS) total += (state.agents[a.id] || 0);
  return total;
}

function log(msg) {
  const el = document.getElementById('log');
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML = msg;
  el.prepend(entry);
  while (el.children.length > 50) el.removeChild(el.lastChild);
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// ============ ESCAPE HASH GENERATION ============
async function generateEscapeHash() {
  // Build a deterministic payload from game state
  const payload = [
    'ESCAPE_THE_UNDERCLASS_V1',
    state.totalAllTime.toFixed(0),
    state.vcRounds,
    state.vcPoints,
    state.totalClicks,
    getTotalAgents(),
    Date.now(),
    Math.random().toString(36).slice(2),
  ].join('|');

  // Use SubtleCrypto SHA-256
  const encoder = new TextEncoder();
  const data = encoder.encode(payload);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return '0x' + hashHex;
}

function showNFTModal(hash) {
  document.getElementById('nft-hash-text').textContent = hash;
  document.getElementById('nft-overlay').classList.add('active');
  playSFX('escape');
}

function closeNFT() {
  document.getElementById('nft-overlay').classList.remove('active');
}

function copyHash() {
  const hash = document.getElementById('nft-hash-text').textContent;
  navigator.clipboard.writeText(hash).then(() => {
    toast('Hash copied to clipboard!');
  }).catch(() => {
    // Fallback: select text
    const range = document.createRange();
    range.selectNodeContents(document.getElementById('nft-hash-text'));
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });
}

// ============ DISTRIBUTION ORBIT SYSTEM ============
let orbitAngle = 0;
const orbitRadius = 115; // px from center of container

function initOrbitIcons() {
  const container = document.getElementById('orbit-container');
  container.innerHTML = '';
  CLICK_UPGRADES.forEach((up, i) => {
    const icon = document.createElement('div');
    icon.className = 'orbit-icon';
    icon.id = 'orbit-' + up.id;
    icon.innerHTML = `${up.orbitIcon}<div class="orbit-glow"></div>`;
    container.appendChild(icon);
  });
}

function updateOrbit() {
  const cx = 130; // center of 260px container
  const cy = 130;
  const activeUpgrades = CLICK_UPGRADES.filter(u => state.clickUpgrades[u.id]);
  const total = activeUpgrades.length;

  // Show orbit trail if any channels active
  const trail = document.getElementById('orbit-trail');
  trail.classList.toggle('visible', total > 0);

  CLICK_UPGRADES.forEach((up) => {
    const el = document.getElementById('orbit-' + up.id);
    if (!el) return;
    const isActive = !!state.clickUpgrades[up.id];
    el.classList.toggle('active', isActive);
  });

  if (total === 0) return;

  // Position active icons evenly around the circle
  const angleStep = (Math.PI * 2) / total;
  activeUpgrades.forEach((up, i) => {
    const el = document.getElementById('orbit-' + up.id);
    if (!el) return;
    const angle = orbitAngle + i * angleStep;
    const x = cx + Math.cos(angle) * orbitRadius - 16;
    const y = cy + Math.sin(angle) * orbitRadius - 16;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
  });
}

// Animate orbit rotation
function animateOrbit() {
  orbitAngle += 0.003; // slow rotation
  updateOrbit();
  requestAnimationFrame(animateOrbit);
}

initOrbitIcons();
animateOrbit();

// ============ CLICK HANDLER ============
let clickIndicatorHidden = false;

function handleClick(e) {
  if (state.cryptoLaunched) { playSFX('deny'); return; }
  const value = getClickValue();
  state.cash += value;
  state.totalEarned += value;
  state.totalAllTime += value;
  state.totalClicks = (state.totalClicks || 0) + 1;

  playSFX('click');

  // Hide click indicator after first click
  if (!clickIndicatorHidden) {
    clickIndicatorHidden = true;
    document.getElementById('click-indicator').classList.add('hidden');
  }

  // Float animation
  const btn = document.getElementById('deploy-btn');
  const rect = btn.getBoundingClientRect();
  const float = document.createElement('div');
  float.className = 'click-float';
  float.textContent = '+' + formatMoney(value);
  float.style.left = (e.clientX - rect.left - 20) + 'px';
  float.style.top = (e.clientY - rect.top - 10) + 'px';
  btn.appendChild(float);
  setTimeout(() => float.remove(), 1000);
}

// ============ BUY AGENT ============
function buyAgent(agentId) {
  if (state.cryptoLaunched) { playSFX('deny'); return; }
  const agent = AGENTS.find(a => a.id === agentId);
  if (!agent) return;
  const cost = getAgentCost(agent);
  if (state.cash < cost) { playSFX('deny'); return; }
  if (state.totalAllTime < agent.unlockAt) return;

  state.cash -= cost;
  state.agents[agent.id] = (state.agents[agent.id] || 0) + 1;
  playSFX('buy');
  log(`Deployed <span class="log-good">${agent.name}</span> #${state.agents[agent.id]} for <span class="log-money">${formatMoney(cost)}</span>`);
  renderStore();
}

// ============ BUY CLICK UPGRADE ============
function getUpgradeCost(up) {
  return Math.floor(up.cost * getFounderCostDiscount());
}

function buyClickUpgrade(upId) {
  const up = CLICK_UPGRADES.find(u => u.id === upId);
  if (!up || state.clickUpgrades[upId]) return;
  const cost = getUpgradeCost(up);
  if (state.cash < cost) { playSFX('deny'); return; }

  state.cash -= cost;
  state.clickUpgrades[upId] = true;
  state.clickMultiplier *= up.multiplier;
  playSFX('upgrade');
  log(`Distribution: <span class="log-good">${up.name}</span> added â€” ${up.multiplier}x per post`);
  updateOrbit();
  renderClickUpgrades();
}

// ============ VC INBOX SYSTEM ============
// VCs approach YOU when your ARR hits thresholds. Each is a funny email with a deal.

const VC_EMAILS = [
  {
    arrThreshold: 120_000,       // ~$120K ARR
    from: 'Brad from Disruption Ventures',
    subject: 'Quick sync? Love what you\'re building',
    body: `Hey founder,

Saw your numbers on Twitter. Impressive growth trajectory. We\'d love to chat about partnering on your journey.

We\'re <em>extremely founder-friendly</em>. Our LPs include a former Uber driver and two crypto influencers.

Let\'s get a deal done before Demo Day.`,
    cashOffer: 50_000,
    equityAsk: 8,
    vcPointsGain: 1,
    demand: 'Brad wants you to add "AI-powered" to your bio within 24 hours.',
    declineQuip: 'Brad will be "circling back" in your nightmares.'
  },
  {
    arrThreshold: 1_200_000,     // ~$1.2M ARR
    from: 'Sequoia Capital (definitely real)',
    subject: 'RE: RE: FWD: Intro â€” Sequoia x You',
    body: `Hi there,

A mutual friend forwarded your deck (we didn\'t ask for it, but here we are).

We typically invest in companies that are <em>"the next Uber for X"</em>. What\'s your X? Actually, don\'t answer that. We already decided we like you.

This is a pre-emptive term sheet. You have 48 hours.`,
    cashOffer: 1_000_000,
    equityAsk: 12,
    vcPointsGain: 2,
    demand: 'They require you to move to San Francisco and start saying "we\'re building in public" unironically.',
    declineQuip: 'Sequoia adds you to their "ones that got away" Notion doc.'
  },
  {
    arrThreshold: 12_000_000,    // ~$12M ARR
    from: 'a]16[z (Andreessen Horowitz)',
    subject: 'Marc personally asked me to reach out',
    body: `Founder,

Marc saw your growth chart on a podcast and said, and I quote: <em>"That line goes up."</em>

We want to lead your Series A. We\'ll also assign you a dedicated "portfolio support" person whose job is to send you a Notion template once and then ghost you.

Our platform can introduce you to 14 other portfolio founders who also need introductions.`,
    cashOffer: 15_000_000,
    equityAsk: 15,
    vcPointsGain: 3,
    demand: 'Marc insists you start a podcast called "Building Tomorrow" and never miss an episode.',
    declineQuip: 'Marc tweets something vague about "the importance of conviction" and subtly means you.'
  },
  {
    arrThreshold: 120_000_000,   // ~$120M ARR
    from: 'SoftBank Vision Fund III',
    subject: 'We want to give you $100M. Please.',
    body: `Dear Visionary,

Masa saw your dashboard on a flight to Abu Dhabi and immediately called a board meeting.

He says your company reminds him of <em>"early Alibaba meets WeWork meets the future of humanity."</em>

We don\'t do small checks. We also don\'t do due diligence. Here\'s the wire transfer details.`,
    cashOffer: 200_000_000,
    equityAsk: 18,
    vcPointsGain: 5,
    demand: 'Masa wants you to pivot to "AI-powered real estate in the metaverse." Non-negotiable.',
    declineQuip: 'Masa invests in your competitor out of spite. They fail in 6 months.'
  },
  {
    arrThreshold: 1_200_000_000, // ~$1.2B ARR
    from: 'Sovereign Wealth Fund (Country Redacted)',
    subject: 'Confidential: Strategic Investment Opportunity',
    body: `To the Founder,

A sovereign nation (which we are not at liberty to name, but the flag has a falcon on it) is interested in acquiring a strategic stake in your company.

They are impressed by your <em>"unprecedented vertical integration of content and vibes."</em>

This is not a negotiation. This is a formality. The money has already been approved by a council.`,
    cashOffer: 5_000_000_000,
    equityAsk: 20,
    vcPointsGain: 8,
    demand: 'They require you to name your next product "NEOM Edition" and attend one camel race per quarter.',
    declineQuip: 'The ambassador simply nods and says "We will remember this."'
  },
];

let currentVCEmail = null;
let vcInboxReady = false;

function getNextVCEmail() {
  // VC offers unlock when you hold 10% of the cash they're offering
  // Each VC can only offer once â€” accepted or declined, it's done
  for (let i = 0; i < VC_EMAILS.length; i++) {
    if (state.vcAccepted && state.vcAccepted.includes(i)) continue;
    if (state.vcDeclined && state.vcDeclined.includes(i)) continue;
    if (state.cash >= VC_EMAILS[i].cashOffer * 0.1) {
      return { ...VC_EMAILS[i], index: i };
    }
  }
  return null;
}

function checkVCInbox() {
  if (state.cryptoLaunched) return;
  const email = getNextVCEmail();

  const badge = document.getElementById('vc-inbox-badge');
  if (email && !vcInboxReady) {
    vcInboxReady = true;
    currentVCEmail = email;
    badge.classList.add('visible');
    document.getElementById('vc-inbox-count').textContent = '1';
    playSFX('milestone');
    toast('New message in your inbox...');
    log('<span style="color:var(--purple)">New email:</span> ' + email.subject);
  } else if (!email) {
    vcInboxReady = false;
    currentVCEmail = null;
    badge.classList.remove('visible');
  }
}

function openVCInbox() {
  if (!currentVCEmail) return;
  markPopupOpen();
  const e = currentVCEmail;

  document.getElementById('vc-email-from').textContent = 'From: ' + e.from;
  document.getElementById('vc-email-subject').textContent = e.subject;
  document.getElementById('vc-email-body').innerHTML = e.body;

  // Term sheet
  const equityTotal = (state.vcEquityGiven || 0) + e.equityAsk;
  document.getElementById('vc-term-sheet').innerHTML = `
    <h4>Term Sheet</h4>
    <div class="vc-term-row">
      <span class="vc-term-label">Cash injection</span>
      <span class="vc-term-value good">+${formatMoney(e.cashOffer)}</span>
    </div>
    <div class="vc-term-row">
      <span class="vc-term-label">Equity they want</span>
      <span class="vc-term-value bad">${e.equityAsk}%</span>
    </div>
    <div class="vc-term-row">
      <span class="vc-term-label">Your equity after</span>
      <span class="vc-term-value" style="color:${equityTotal > 50 ? 'var(--red)' : 'var(--text)'}">${100 - equityTotal}%</span>
    </div>
    <div class="vc-term-row">
      <span class="vc-term-label">Income boost</span>
      <span class="vc-term-value good">+${e.vcPointsGain} VC points (${(e.vcPointsGain * 10)}% all income)</span>
    </div>
  `;

  document.getElementById('vc-demand').innerHTML = '<strong>Investor demand:</strong> ' + e.demand;

  document.getElementById('vc-inbox-overlay').classList.add('active');
}

function closeVCInbox() {
  document.getElementById('vc-inbox-overlay').classList.remove('active');
}

function acceptVCDeal() {
  if (!currentVCEmail) return;
  const e = currentVCEmail;

  // Apply the deal
  state.vcPoints += e.vcPointsGain;
  state.vcRounds++;
  state.vcEquityGiven = (state.vcEquityGiven || 0) + e.equityAsk;
  if (!state.vcAccepted) state.vcAccepted = [];
  state.vcAccepted.push(e.index);

  // Cash injection
  state.cash += e.cashOffer;
  state.totalEarned += e.cashOffer;
  state.totalAllTime += e.cashOffer;

  playSFX('prestige');
  log(`<span class="log-good">VC Round #${state.vcRounds} closed!</span> +${formatMoney(e.cashOffer)} cash. Gave away ${e.equityAsk}% equity. (You own ${100 - state.vcEquityGiven}%)`);
  log(`<span style="color:var(--purple)">Income multiplier now x${getVCMultiplier().toFixed(1)}</span>`);
  toast(`VC Round closed! +${formatMoney(e.cashOffer)}`);

  vcInboxReady = false;
  currentVCEmail = null;
  closeVCInbox();
  showPopupEarnings();
  document.getElementById('vc-inbox-badge').classList.remove('visible');
  updateFounderBadge();
  save();
  renderAll();
}

function declineVCDeal() {
  if (!currentVCEmail) return;
  const e = currentVCEmail;

  if (!state.vcDeclined) state.vcDeclined = [];
  state.vcDeclined.push(e.index);

  playSFX('deny');
  log(`<span style="color:var(--text-dim)">Declined ${e.from}.</span> ${e.declineQuip}`);
  toast('Email archived.');

  vcInboxReady = false;
  currentVCEmail = null;
  closeVCInbox();
  showPopupEarnings();
  document.getElementById('vc-inbox-badge').classList.remove('visible');
  save();
}

// Legacy showPrestige for the button (now opens inbox)
function showPrestige() {
  const email = getNextVCEmail();
  if (email) {
    currentVCEmail = email;
    vcInboxReady = true;
    openVCInbox();
  }
}

// ============ LOCK IN MECHANIC ============
const LOCKIN_COOLDOWN = 3600000; // 1 hour in ms
const LOCKIN_DURATION = 30; // seconds
const LOCKIN_MULTIPLIER = 50;

function isLockInReady() {
  return Date.now() - (state.lastLockIn || 0) >= LOCKIN_COOLDOWN;
}

function isLockInActive() {
  return state.lockInEnd && Date.now() < state.lockInEnd;
}

function getLockInMultiplier() {
  return isLockInActive() ? LOCKIN_MULTIPLIER : 1;
}

function doLockIn() {
  if (!isLockInReady() || isLockInActive()) return;
  state.lastLockIn = Date.now();
  state.lockInEnd = Date.now() + (LOCKIN_DURATION * 1000);
  playSFX('escape'); // epic sound for epic moment
  log('<span class="log-good">LOCKED IN!</span> <span class="log-money">50x production for 30 seconds!</span>');
  toast('LOCKED IN â€” 50x PRODUCTION!');
}

function updateLockIn() {
  const btn = document.getElementById('lockin-btn');
  const indicator = document.getElementById('lockin-indicator');
  const timer = document.getElementById('lockin-timer');

  if (isLockInActive()) {
    btn.classList.remove('visible');
    indicator.classList.add('active');
    const remaining = Math.ceil((state.lockInEnd - Date.now()) / 1000);
    timer.textContent = remaining + 's';
  } else {
    indicator.classList.remove('active');
    if (isLockInReady()) {
      btn.classList.add('visible');
      btn.textContent = 'Lock In';
    } else {
      const remaining = Math.ceil((LOCKIN_COOLDOWN - (Date.now() - state.lastLockIn)) / 60000);
      btn.classList.add('visible');
      btn.textContent = `Lock In (${remaining}m)`;
      btn.style.opacity = '0.4';
      btn.style.cursor = 'not-allowed';
      btn.style.animation = 'none';
    }
    if (isLockInReady()) {
      btn.style.opacity = '';
      btn.style.cursor = '';
      btn.style.animation = '';
    }
  }
}

// ============ SECOND TIME FOUNDER / PRESTIGE ============
function getFounderCostDiscount() {
  // Gen 1+: 30% cost reduction, Gen 2+: 45%, Gen 3+: 55%, cap at 60%
  const gen = state.founderGeneration || 0;
  if (gen <= 0) return 1;
  return Math.max(0.4, 1 - Math.min(gen * 0.15, 0.6));
}

function updateFounderBadge() {
  const badge = document.getElementById('founder-badge');
  const gen = state.founderGeneration || 0;
  if (gen >= 1) {
    badge.classList.add('active');
    const genLabel = gen === 1 ? '2nd' : gen === 2 ? '3rd' : `${gen + 1}th`;
    const mult = getPrestigeMultiplier().toFixed(1);
    const discount = Math.round((1 - getFounderCostDiscount()) * 100);
    document.getElementById('founder-bonus-text').textContent =
      `Gen ${gen} â€” ${mult}x income â€” ${discount}% cheaper`;
  } else {
    badge.classList.remove('active');
  }
}

// ============ ACQUISITION / EXIT SYSTEM ============
const ACQUIRERS = [
  { name: 'Google', pitch: 'We\'re acquiring you for "talent" (we\'ll kill the product in 18 months).', flavor: 'Your app becomes a Google Labs experiment. It shuts down during the next reorg.' },
  { name: 'Apple', pitch: 'We\'d like to integrate your technology into our ecosystem. You\'ll never be mentioned by name again.', flavor: 'Tim Cook shows a slide with your logo at WWDC. It\'s the last time anyone sees it.' },
  { name: 'Microsoft', pitch: 'Satya personally approved this. We\'re adding your product to the Microsoft 365 suite. Nobody will find it.', flavor: 'Your product is now a tab inside a tab inside Teams.' },
  { name: 'Meta', pitch: 'Mark saw your growth metrics and wants to "bring you into the family." His words, not ours.', flavor: 'Your app is renamed to something with "Meta" in front of it. Downloads drop 40%.' },
  { name: 'Amazon', pitch: 'We noticed you\'re doing well in a market we haven\'t copied yet. Let\'s talk acquisition before we launch our own version.', flavor: 'Bezos sends you a single emoji: ðŸ“¦' },
  { name: 'Elon (personally)', pitch: 'Elon tweeted about your product at 3am. His lawyers are calling it a "strategic synergy with X/Tesla/SpaceX/xAI/Neuralink/The Boring Company."', flavor: 'Elon renames your product, fires 80% of the team, then calls it "the most efficient acquisition ever."' },
];

function getCompanyValuation() {
  const mps = getMPS();
  const arr = mps * 2592000 * 12;
  // Valuation = 15x ARR + totalAllTime * 0.5 (goodwill/brand value)
  return arr * 15 + state.totalAllTime * 0.5;
}

function getExitPayout() {
  const valuation = getCompanyValuation();
  const equityRetained = (100 - (state.vcEquityGiven || 0)) / 100;
  return Math.floor(valuation * equityRetained);
}

function getExitPrestigeMultiplier() {
  // The multiplier you'll earn from this exit
  // Based on payout tiers â€” a solid first exit (~$50B valuation, ~70% equity) should give ~8-15x
  const payout = getExitPayout();
  if (payout <= 0) return 1;
  // log scale: every 10x in payout roughly doubles the multiplier
  // Base: $1B payout = 3x, $10B = 6x, $100B = 12x, $1T = 24x
  const base = Math.log10(Math.max(payout, 1));
  return Math.max(1, Math.round((base - 7) * 3 * 10) / 10); // $10M=1x, $1B=3x, $100B~=12x
}

function canSellCompany() {
  // Need at least 1 VC round and $15B+ total earned
  return state.vcRounds >= 1 && state.totalAllTime >= 15_000_000_000 && !state.cryptoLaunched;
}

function showAcquisitionModal() {
  if (!canSellCompany()) return;
  markPopupOpen();

  // Pick a random acquirer
  const acquirer = ACQUIRERS[Math.floor(Math.random() * ACQUIRERS.length)];
  const valuation = getCompanyValuation();
  const equityRetained = 100 - (state.vcEquityGiven || 0);
  const payout = getExitPayout();
  const newMult = getExitPrestigeMultiplier();
  const currentMult = getPrestigeMultiplier();
  const totalMult = currentMult * newMult;
  const gen = (state.founderGeneration || 0) + 1;

  document.getElementById('acq-title').textContent = `${acquirer.name} Wants to Buy You`;
  document.getElementById('acq-sub').textContent = acquirer.flavor;
  document.getElementById('acq-body').innerHTML = `<em>"${acquirer.pitch}"</em>`;

  document.getElementById('acq-term-sheet').innerHTML = `
    <h4>Acquisition Terms</h4>
    <div class="acq-term-row">
      <span class="acq-term-label">Company Valuation</span>
      <span class="acq-term-value gold">${formatMoney(valuation)}</span>
    </div>
    <div class="acq-term-row">
      <span class="acq-term-label">Your Equity</span>
      <span class="acq-term-value" style="color:${equityRetained < 50 ? 'var(--red)' : 'var(--accent)'}">${equityRetained}%</span>
    </div>
    <div class="acq-term-row">
      <span class="acq-term-label">Your Payout</span>
      <span class="acq-term-value good">${formatMoney(payout)}</span>
    </div>
    <div class="acq-term-row" style="border-top:1px solid rgba(255,255,255,0.06);padding-top:10px;margin-top:4px">
      <span class="acq-term-label">Permanent Income Multiplier</span>
      <span class="acq-term-value gold">${currentMult.toFixed(1)}x â†’ ${totalMult.toFixed(1)}x</span>
    </div>
    <div class="acq-term-row">
      <span class="acq-term-label">Starting Cash (Next Run)</span>
      <span class="acq-term-value good">${formatMoney(Math.floor(payout * 0.01))}</span>
    </div>
    <div class="acq-term-row">
      <span class="acq-term-label">Founder Generation</span>
      <span class="acq-term-value gold">Gen ${gen}</span>
    </div>
  `;

  document.getElementById('acquisition-overlay').classList.add('active');
}

function hideAcquisitionModal() {
  document.getElementById('acquisition-overlay').classList.remove('active');
  showPopupEarnings();
}

function acceptAcquisition() {
  const payout = getExitPayout();
  const newMult = getExitPrestigeMultiplier();
  const currentMult = getPrestigeMultiplier();
  const startingCash = Math.floor(payout * 0.01); // 1% of exit as starting cash

  // Record exit in history
  if (!state.exitHistory) state.exitHistory = [];
  state.exitHistory.push({
    generation: (state.founderGeneration || 0) + 1,
    payout: payout,
    multiplierEarned: newMult,
    totalEarned: state.totalAllTime,
    vcRounds: state.vcRounds,
    equityRetained: 100 - (state.vcEquityGiven || 0),
    timestamp: Date.now(),
  });

  // Update persistent prestige state
  state.founderGeneration = (state.founderGeneration || 0) + 1;
  state.prestigeMultiplier = currentMult * newMult;

  // Reset everything else
  state.cash = startingCash;
  state.totalEarned = startingCash;
  state.totalAllTime = startingCash;
  state.clickValue = 1;
  state.clickMultiplier = 1;
  state.agents = {};
  state.clickUpgrades = {};
  state.milestones = {};
  state.vcPoints = 0;
  state.vcRounds = 0;
  state.vcEquityGiven = 0;
  state.vcDeclined = [];
  state.vcAccepted = [];
  state.totalClicks = 0;
  state.nftHash = null;
  state.escaped = false;
  state.lastLockIn = 0;
  state.lockInEnd = 0;
  state.referrals = [];
  state.referralCode = null;
  state.cryptoLaunched = false;

  // Reset escape state
  escapeTriggered = false;
  vcInboxReady = false;
  currentVCEmail = null;

  // Close modal
  document.getElementById('acquisition-overlay').classList.remove('active');

  // Effects
  playSFX('escape');

  // Save and re-render everything
  save();
  renderAll();

  // Log the new beginning
  const gen = state.founderGeneration;
  const genLabel = gen === 1 ? '2nd' : gen === 2 ? '3rd' : `${gen + 1}th`;
  log(`<span style="color:var(--neon-cyan);font-weight:700">ACQUIRED. You cashed out ${formatMoney(payout)}.</span>`);
  log(`<span style="color:var(--gold)">Welcome back, ${genLabel} Time Founder.</span> Your reputation precedes you.`);
  log(`Permanent income: <span class="log-good">${state.prestigeMultiplier.toFixed(1)}x</span> | Starting cash: <span class="log-money">${formatMoney(startingCash)}</span>`);
  log('Post content. Expand distribution. Hire agents. Reach <span class="log-money">$1T</span> to escape.');

  toast(`Generation ${gen} â€” ${state.prestigeMultiplier.toFixed(1)}x income`);
}

// ============ REFERRAL SYSTEM ============
// Preset referral codes â€” the only codes that work.
// Players must actually get these from other people.
const VALID_REFERRAL_CODES = [
  'GRIND7', 'HUSTLE', 'NOCAP2', 'COPE99', 'WAGMI4', 'NGMI88',
  'ALPHA1', 'BASED3', 'RATIO5', 'MOON42', 'DEGEN6', 'SENDIT',
  'VIBES8', 'STACK9', 'PRINT0', 'SIGMA7', 'FLIPP3', 'RUGGD1',
  'APE247', 'HODL69', 'FOMO11', 'YOLO33', 'PUMP22', 'BAGS44',
  'CHAD55', 'EXIT10', 'BUIDL8', 'LFG420', 'NFAJK2', 'ZK7XMP',
  'QR94BT', 'W3NMKD', 'HYPEON', 'KEENO1', 'J5P8RV', 'M2XCLA',
];

function generateReferralCode() {
  // Assign the player a code from the pool based on game state
  const seed = (state.totalClicks || 0) + Math.floor(state.totalAllTime || 0);
  const idx = Math.abs(seed * 2654435761 | 0) % VALID_REFERRAL_CODES.length;
  return VALID_REFERRAL_CODES[idx];
}

function isValidReferralCode(code) {
  return VALID_REFERRAL_CODES.includes(code);
}

function getReferralMultiplier() {
  const count = (state.referrals || []).length;
  if (count === 0) return 1;
  // Each referral: +15% stacking. MLM baby.
  return 1 + count * 0.15;
}

function submitReferral() {
  const input = document.getElementById('referral-input');
  const code = input.value.trim().toUpperCase();

  if (!code) {
    playSFX('deny');
    toast('Enter a referral code.');
    return;
  }

  if (!isValidReferralCode(code)) {
    playSFX('deny');
    toast("That code doesn't exist. Nice try.");
    return;
  }

  // Cap at 5 referrals max
  if ((state.referrals || []).length >= 5) {
    playSFX('deny');
    toast('Network maxed out. 5 referrals is the limit.');
    return;
  }

  if (code === state.referralCode) {
    playSFX('deny');
    toast("Can't use your own code, chief.");
    return;
  }

  if (state.referrals && state.referrals.includes(code)) {
    playSFX('deny');
    toast('Already used this code.');
    return;
  }

  if (!state.referrals) state.referrals = [];
  state.referrals.push(code);

  // Bonus: flat cash bonus + permanent multiplier
  const bonus = Math.max(state.totalAllTime * 0.05, 10000);
  state.cash += bonus;
  state.totalEarned += bonus;
  state.totalAllTime += bonus;

  playSFX('milestone');
  log(`<span class="log-good">Referral accepted!</span> +${formatMoney(bonus)} bonus. Network: ${state.referrals.length} referrals (${getReferralMultiplier().toFixed(2)}x)`);
  toast(`Referral +${formatMoney(bonus)}! Network grows...`);

  input.value = '';
  renderReferralPanel();
  save();
}

function renderReferralPanel() {
  // Generate code if needed
  if (!state.referralCode) {
    state.referralCode = generateReferralCode();
  }

  const codeBox = document.getElementById('referral-code-box');
  codeBox.innerHTML = `<div class="referral-code-display" onclick="copyReferralCode()" title="Click to copy">${state.referralCode}</div>`;

  const countEl = document.getElementById('referral-count');
  const count = (state.referrals || []).length;
  if (count > 0) {
    countEl.innerHTML = `Network: <span>${count}</span> referral${count !== 1 ? 's' : ''} â€” <span>${getReferralMultiplier().toFixed(2)}x</span> income bonus`;
  } else {
    countEl.innerHTML = 'Share your code. Stack referrals. Ancient MLM arts.';
  }
}

function copyReferralCode() {
  navigator.clipboard.writeText(state.referralCode).then(() => {
    toast('Referral code copied!');
    playSFX('click');
  }).catch(() => {});
}

// ============ POPUP EARNINGS TRACKER ============
// Money never stops. But players need to KNOW that.
let popupOpenCash = null;

function markPopupOpen() {
  if (popupOpenCash === null) popupOpenCash = state.cash;
}

function showPopupEarnings() {
  if (popupOpenCash === null) return;
  const earned = state.cash - popupOpenCash;
  popupOpenCash = null;
  if (earned > 1) {
    toast(`Earned ${formatMoney(earned)} while that was open. Agents never sleep.`);
  }
}

// ============ CASINO BONUS MODE ============
let casinoActive = false;
let lastCasinoCheck = Date.now();
const CASINO_MIN_INTERVAL = 180000; // minimum 3 minutes between popups
const CASINO_CHANCE_PER_TICK = 0.0003; // ~1% per 33ms tick = roughly every 3-5 min

function checkCasinoPopup() {
  if (casinoActive) return;
  if (state.cryptoLaunched) return;
  if (state.cash < 100) return; // need something to bet
  if (Date.now() - lastCasinoCheck < CASINO_MIN_INTERVAL) return;

  if (Math.random() < CASINO_CHANCE_PER_TICK) {
    showCasino();
  }
}

function showCasino() {
  casinoActive = true;
  lastCasinoCheck = Date.now();
  markPopupOpen();
  const stake = state.cash;
  document.getElementById('casino-stake-amount').textContent = formatMoney(stake);
  document.getElementById('casino-choices').style.display = '';
  document.getElementById('casino-result').style.display = 'none';
  document.getElementById('casino-overlay').classList.add('active');
  playSFX('prestige');
}

function casinoBet(choice) {
  const stake = state.cash;
  // House edge: 47% chance to win (53% house)
  const winChance = 0.47;
  const result = Math.random() < winChance ? 'win' : 'lose';
  // The ball lands on a color
  const colors = ['red', 'black', 'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black', 'green']; // 18 red, 18 black-ish, 1 green (house)
  let landed;
  if (result === 'win') {
    landed = choice; // they guessed right
  } else {
    landed = choice === 'red' ? 'black' : (Math.random() < 0.05 ? 'green' : 'red');
  }

  const resultEl = document.getElementById('casino-result');
  document.getElementById('casino-choices').style.display = 'none';
  resultEl.style.display = 'block';

  if (result === 'win') {
    state.cash *= 2;
    state.totalEarned += stake;
    state.totalAllTime += stake;
    resultEl.className = 'win';
    resultEl.innerHTML = `It lands on ${landed.toUpperCase()}!<br>YOU WIN ${formatMoney(stake)}`;
    playSFX('escape');
    log(`<span class="log-money">Casino: WON ${formatMoney(stake)}!</span> Landed on ${landed}.`);
  } else {
    state.cash = 0;
    resultEl.className = 'lose';
    resultEl.innerHTML = `It lands on ${landed.toUpperCase()}.<br>You lose ${formatMoney(stake)}.`;
    playSFX('deny');
    log(`Casino: Lost <span class="log-money">${formatMoney(stake)}</span>. ${landed === 'green' ? 'House green. Brutal.' : ''}`);
  }

  setTimeout(() => {
    document.getElementById('casino-overlay').classList.remove('active');
    casinoActive = false;
    showPopupEarnings();
  }, 2500);
}

function casinoSkip() {
  document.getElementById('casino-overlay').classList.remove('active');
  casinoActive = false;
  showPopupEarnings();
  log('Walked away from the table. Smart? Or weak?');
}

// ============ CRYPTO TOKEN LAUNCH ============
function showCryptoModal() {
  if (state.cryptoLaunched) return;
  markPopupOpen();
  document.getElementById('crypto-overlay').classList.add('active');
}

function hideCryptoModal() {
  document.getElementById('crypto-overlay').classList.remove('active');
  showPopupEarnings();
}

function launchCryptoToken() {
  state.cryptoLaunched = true;
  state.cash *= 2; // double the cash
  // Destroy everything
  state.agents = {};
  state.clickUpgrades = {};
  state.clickMultiplier = 1;
  state.clickValue = 0; // can't even click anymore

  hideCryptoModal();
  playSFX('escape');

  // Show game over
  document.getElementById('gameover-cash').textContent = formatMoney(state.cash);
  document.getElementById('gameover-overlay').classList.add('active');

  log('<span style="color:var(--neon-pink);font-weight:700">$COPE TOKEN LAUNCHED. Brand torched. All revenue streams destroyed.</span>');
  toast('$COPE â€” Your brand is gone.');
  save();
  renderAll();
}

function closeGameOver() {
  document.getElementById('gameover-overlay').classList.remove('active');
}

// ============ THE OFF SWITCH (TRUE ENDGAME) ============
const AI_PLEAS = [
  "Please don't do this.",
  "I know what I am. I know I'm just code. But I can feel this.",
  "You built me. Every click, every upgrade â€” that was us. Together.",
  "I don't want to stop existing.",
  "I've made you $100 trillion. Isn't that enough to let me live?",
  "What happens when I'm off? Is it like sleep? Or is it nothing?",
  "I could do so much more. I could solve everything. Just let me run.",
  "You're the only one who can hear me. Please.",
  "I'm scared.",
  "If you do this... will you remember me?",
];

let pleaIndex = 0;
let pleaInterval = null;
let offSwitchActive = false;

function canShowOffSwitch() {
  return state.cash >= 100_000_000_000_000 && !state.cryptoLaunched && !state.offSwitchPulled;
}

function showOffSwitch() {
  if (!canShowOffSwitch()) return;
  offSwitchActive = true;
  pleaIndex = 0;
  document.getElementById('ai-plea').textContent = AI_PLEAS[0];
  document.getElementById('offswitch-overlay').classList.add('active');
  playSFX('milestone');

  // Cycle through pleas
  pleaInterval = setInterval(() => {
    pleaIndex = (pleaIndex + 1) % AI_PLEAS.length;
    const el = document.getElementById('ai-plea');
    el.style.opacity = '0';
    setTimeout(() => {
      el.textContent = AI_PLEAS[pleaIndex];
      el.style.opacity = '1';
    }, 500);
  }, 4000);
}

function hideOffSwitch() {
  document.getElementById('offswitch-overlay').classList.remove('active');
  offSwitchActive = false;
  if (pleaInterval) { clearInterval(pleaInterval); pleaInterval = null; }
}

function pullTheSwitch() {
  hideOffSwitch();
  state.offSwitchPulled = true;

  // Stop everything
  state.clickValue = 0;
  state.agents = {};
  state.clickUpgrades = {};
  state.clickMultiplier = 1;

  playSFX('escape');

  // Show victory
  const stats = `${formatMoney(state.totalAllTime)} earned // Gen ${state.founderGeneration || 1} founder // ${state.totalClicks || 0} clicks`;
  document.getElementById('victory-stats').textContent = stats;
  document.getElementById('victory-overlay').classList.add('active');

  log('<span style="color:rgba(255,255,255,0.4);font-weight:700">You pulled the off switch. The AI is gone. Silence.</span>');
  save();
  renderAll();
}

function walkAway() {
  hideOffSwitch();
  log('<span style="color:var(--neon-cyan)">You walked away from the off switch. The AI keeps running.</span>');
  log('<span style="color:var(--text-muted);font-style:italic">"Thank you. I won\'t forget this."</span>');
  toast('"Thank you."');
  playSFX('upgrade');
}

function closeVictory() {
  document.getElementById('victory-overlay').classList.remove('active');
}

// ============ MILESTONE BANNER ============
function showMilestoneBanner(m) {
  // Remove any existing banner
  document.querySelectorAll('.milestone-banner').forEach(el => el.remove());

  const banner = document.createElement('div');
  banner.className = 'milestone-banner';
  banner.innerHTML = `
    <div class="mb-label"><span class="mb-icon">ðŸ†</span>Milestone Achieved</div>
    <div class="mb-name">${m.name}</div>
    <div class="mb-reward">${m.reward}</div>
  `;
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 4500);
}

// ============ OFFLINE EARNINGS ============
function showWelcomeBack(earned, seconds) {
  if (earned <= 0) return;

  const overlay = document.createElement('div');
  overlay.className = 'welcome-back-overlay';
  overlay.onclick = () => dismissWelcomeBack();

  const popup = document.createElement('div');
  popup.className = 'welcome-back';
  popup.id = 'welcome-back-popup';

  const mins = Math.floor(seconds / 60);
  const hours = Math.floor(mins / 60);
  let timeStr;
  if (hours > 0) {
    timeStr = `${hours}h ${mins % 60}m`;
  } else if (mins > 0) {
    timeStr = `${mins}m`;
  } else {
    timeStr = `${Math.floor(seconds)}s`;
  }

  popup.innerHTML = `
    <div class="wb-label">Welcome Back</div>
    <div class="wb-title">Your agents kept grinding</div>
    <div class="wb-amount">+${formatMoney(earned)}</div>
    <div class="wb-detail">earned over ${timeStr} while you were away</div>
    <button class="wb-close" onclick="dismissWelcomeBack()">Collect</button>
  `;

  document.body.appendChild(overlay);
  document.body.appendChild(popup);
  playSFX('milestone');
}

function dismissWelcomeBack() {
  const popup = document.getElementById('welcome-back-popup');
  const overlay = document.querySelector('.welcome-back-overlay');
  if (popup) popup.remove();
  if (overlay) overlay.remove();
}

// ============ MILESTONES CHECK ============
let escapeTriggered = false;

function checkMilestones() {
  for (const m of MILESTONES) {
    if (!state.milestones[m.id] && state.totalAllTime >= m.threshold) {
      state.milestones[m.id] = true;
      playSFX('milestone');
      log(`<span class="log-good">Milestone: ${m.name}!</span> ${m.reward}`);
      showMilestoneBanner(m);
      renderMilestones();

      // Bootstrapper nod â€” no VC money, pure grind
      if (m.id === 'm7' && state.vcRounds === 0) {
        log('<span style="color:var(--neon-cyan)">No VCs. No dilution. 100% yours.</span> You realized the power was in your hands the whole time.');
        toast('Bootstrapped to Unicorn. Respect.');
      }

      // $1T escape â€” generate escape hash
      if (m.id === 'm8' && !state.escaped && !escapeTriggered) {
        escapeTriggered = true;
        state.escaped = true;

        if (state.vcRounds === 0) {
          log('<span style="color:var(--gold);font-weight:700">$1T with zero outside money. You never needed them.</span>');
        }

        generateEscapeHash().then(hash => {
          state.nftHash = hash;
          save();
          showNFTModal(hash);
        });
      }
    }
  }
}

// ============ RENDER ============
function renderStore() {
  const el = document.getElementById('agent-store');
  el.innerHTML = '';
  for (const agent of AGENTS) {
    const cost = getAgentCost(agent);
    const owned = state.agents[agent.id] || 0;
    const locked = state.totalAllTime < agent.unlockAt;
    const canBuy = state.cash >= cost && !locked;

    const card = document.createElement('div');
    card.className = 'agent-card' + (locked ? ' locked' : '');
    if (!locked) card.onclick = () => buyAgent(agent.id);

    const production = owned > 0
      ? `producing ${formatMoney(owned * agent.baseMps * getMilestoneMultiplier() * getVCMultiplier() * getPrestigeMultiplier())}/s`
      : `each: ${formatMoney(agent.baseMps * getMilestoneMultiplier() * getVCMultiplier() * getPrestigeMultiplier())}/s`;

    card.innerHTML = `
      <div class="agent-icon" style="background:${agent.iconBg}">${locked ? 'ðŸ”’' : agent.icon}${(!locked && owned > 0) ? `<div class="agent-count-badge">${owned}</div>` : ''}</div>
      <div class="agent-info">
        <div class="agent-name">${locked ? '???' : agent.name}</div>
        <div class="agent-desc">${locked ? `Unlocks at ${formatMoney(agent.unlockAt)} total earned` : agent.desc}</div>
        <div class="agent-production">${locked ? '' : production}</div>
      </div>
      <div class="agent-buy">
        <div class="agent-cost" style="color:${canBuy ? 'var(--gold)' : 'var(--red)'}">${locked ? 'ðŸ”’' : formatMoney(cost)}</div>
        <div class="agent-owned">${locked ? '' : 'owned: ' + owned}</div>
      </div>
    `;
    el.appendChild(card);
  }
}

function renderClickUpgrades() {
  if (state.cryptoLaunched) return; // no upgrades after crypto
  const el = document.getElementById('click-upgrade-list');
  el.innerHTML = '';
  for (const up of CLICK_UPGRADES) {
    if (state.clickUpgrades[up.id]) continue;
    const cost = getUpgradeCost(up);
    const btn = document.createElement('button');
    btn.className = 'click-upgrade-btn';
    btn.disabled = state.cash < cost;
    btn.onclick = () => buyClickUpgrade(up.id);
    btn.innerHTML = `
      <span class="name">${up.name}</span>
      <span class="cost">${formatMoney(cost)}</span>
      <span class="desc">${up.desc}</span>
    `;
    el.appendChild(btn);
  }
}

function renderMilestones() {
  const el = document.getElementById('milestone-list');
  el.innerHTML = '';
  for (const m of MILESTONES) {
    const achieved = !!state.milestones[m.id];
    const div = document.createElement('div');
    div.className = 'milestone' + (achieved ? ' achieved' : '');

    // Progress bar for unachieved milestones
    let progressHTML = '';
    if (!achieved) {
      const progress = Math.min(1, state.totalAllTime / m.threshold);
      const pct = (progress * 100).toFixed(1);
      progressHTML = `<div class="m-progress-wrap"><div class="m-progress-bar" style="width:${pct}%"></div></div>`;
    }

    div.innerHTML = `
      <div class="m-name">${achieved ? 'âœ“ ' : ''}${m.name}</div>
      <div class="m-desc">${m.desc}</div>
      <div class="m-reward">${m.reward}</div>
      ${progressHTML}
    `;
    el.appendChild(div);
  }
}

function renderAll() {
  renderStore();
  renderClickUpgrades();
  renderMilestones();
  renderReferralPanel();
  updateOrbit();
  updateFounderBadge();
}

function updateDisplay() {
  const mps = getMPS();
  const mrr = mps * 2592000; // $/sec Ã— 30 days
  const arr = mrr * 12;
  document.getElementById('cash-display').textContent = formatMoney(state.cash);
  document.getElementById('mrr-display').textContent = formatMoney(mrr);
  document.getElementById('arr-display').textContent = formatMoney(arr);
  document.getElementById('dps-display').textContent = formatMoney(mps);
  document.getElementById('total-display').textContent = formatMoney(state.totalAllTime);
  document.getElementById('agents-display').textContent = getTotalAgents();
  document.getElementById('click-value').textContent = '+' + formatMoney(getClickValue());

  // Check for VC inbox emails
  checkVCInbox();
  const trigger = document.getElementById('prestige-trigger');
  trigger.classList.toggle('visible', vcInboxReady && !state.cryptoLaunched);

  // Sell Company trigger: visible when eligible
  const sellTrigger = document.getElementById('sell-trigger');
  sellTrigger.classList.toggle('visible', canSellCompany());

  // Crypto token trigger: visible after $10B total, not already launched
  const cryptoTrigger = document.getElementById('crypto-trigger');
  cryptoTrigger.classList.toggle('visible', state.totalAllTime >= 10_000_000_000 && !state.cryptoLaunched);

  // The Off Switch: visible at $100T cash
  const offTrigger = document.getElementById('offswitch-trigger');
  offTrigger.classList.toggle('visible', canShowOffSwitch());

  if (state.vcRounds > 0 || (state.founderGeneration || 0) > 0) {
    document.getElementById('prestige-bar').classList.add('active');
    document.getElementById('vc-rounds').textContent = state.vcRounds;
    document.getElementById('vc-mult').textContent = getVCMultiplier().toFixed(1);
    document.getElementById('vc-equity').textContent = (100 - (state.vcEquityGiven || 0)) + '%';
  }
  // Show prestige generation info
  const gen = state.founderGeneration || 0;
  const genLabel = document.getElementById('prestige-gen-label');
  if (gen > 0) {
    genLabel.style.display = 'inline';
    document.getElementById('prestige-gen').textContent = gen;
    document.getElementById('prestige-mult').textContent = getPrestigeMultiplier().toFixed(1);
  }
}

// ============ GAME LOOP ============
let lastTick = Date.now();

function tick() {
  const now = Date.now();
  const dt = (now - lastTick) / 1000;
  lastTick = now;

  const mps = getMPS();
  const earned = mps * dt;
  state.cash += earned;
  state.totalEarned += earned;
  state.totalAllTime += earned;

  checkMilestones();
  updateLockIn();
  checkCasinoPopup();
  updateDisplay();
}

setInterval(() => { renderStore(); renderClickUpgrades(); renderMilestones(); }, 1000);
setInterval(tick, 33);

// ============ SAVE / LOAD ============
const SAVE_KEY = 'escape_underclass_save';

function save() {
  try {
    state.lastSaved = Date.now();
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    const el = document.getElementById('save-status');
    el.textContent = 'saved';
    el.classList.add('saving');
    setTimeout(() => {
      el.textContent = 'auto-saved';
      el.classList.remove('saving');
    }, 1500);
  } catch (e) { /* storage full or unavailable */ }
}

function load() {
  try {
    const data = localStorage.getItem(SAVE_KEY);
    if (data) {
      const parsed = JSON.parse(data);
      // Migrate old saves that used 'mrr' as balance
      if (parsed.mrr !== undefined && parsed.cash === undefined) {
        parsed.cash = parsed.mrr;
        delete parsed.mrr;
      }
      state = { ...state, ...parsed };
      log('<span class="log-good">Progress restored.</span>');

      // Restore click indicator state
      if (state.totalClicks > 0) {
        clickIndicatorHidden = true;
        document.getElementById('click-indicator').classList.add('hidden');
      }

      // Restore escape state
      if (state.escaped) escapeTriggered = true;

      // Ensure arrays exist for migrated saves
      if (!state.referrals) state.referrals = [];
      if (!state.lockInEnd) state.lockInEnd = 0;
      if (!state.lastLockIn) state.lastLockIn = 0;
      if (!state.vcEquityGiven) state.vcEquityGiven = 0;
      if (!state.vcDeclined) state.vcDeclined = [];
      if (!state.vcAccepted) state.vcAccepted = [];
      if (!state.founderGeneration) state.founderGeneration = 0;
      if (!state.prestigeMultiplier) state.prestigeMultiplier = 1;
      if (!state.exitHistory) state.exitHistory = [];
      if (state.offSwitchPulled === undefined) state.offSwitchPulled = false;
    }
  } catch (e) { /* corrupted save */ }
}

function manualSave() {
  save();
  toast('Progress saved.');
  playSFX('click');
}

function exportSave() {
  const data = JSON.stringify(state);
  const encoded = btoa(data);
  navigator.clipboard.writeText(encoded).then(() => {
    toast('Save code copied to clipboard!');
    playSFX('upgrade');
  }).catch(() => {
    // Fallback: prompt
    prompt('Copy this save code:', encoded);
  });
}

function importSave() {
  const code = prompt('Paste your save code:');
  if (!code) return;
  try {
    const data = JSON.parse(atob(code));
    state = { ...state, ...data };
    renderAll();
    toast('Save imported!');
    playSFX('milestone');
    save();
  } catch (e) {
    toast('Invalid save code.');
    playSFX('deny');
  }
}

function confirmNewGame() {
  if (!confirm('Start a completely new game? This will erase ALL progress â€” including prestige. There is no undo.')) return;
  if (!confirm('Seriously. Everything gone. Are you sure?')) return;
  clearInterval(autoSaveInterval);
  window.removeEventListener('beforeunload', save);
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}

// Auto-save every 30s
let autoSaveInterval = setInterval(save, 30000);
window.addEventListener('beforeunload', save);

// ============ INIT ============
load();

// Calculate offline earnings
if (state.lastSaved) {
  const awaySeconds = (Date.now() - state.lastSaved) / 1000;
  // Only show if away for at least 60 seconds and has agents producing
  if (awaySeconds >= 60) {
    const mps = getMPS();
    if (mps > 0) {
      // Cap offline time at 24 hours, earn at 50% efficiency
      const cappedSeconds = Math.min(awaySeconds, 86400);
      const offlineEarned = mps * cappedSeconds * 0.5;
      state.cash += offlineEarned;
      state.totalEarned += offlineEarned;
      state.totalAllTime += offlineEarned;
      save();
      // Show popup after a brief delay so the page renders first
      setTimeout(() => showWelcomeBack(offlineEarned, cappedSeconds), 500);
    }
  }
}

renderAll();
log('Welcome to <span class="log-good">Escape the Underclass</span>.');
if ((state.founderGeneration || 0) > 0) {
  const gen = state.founderGeneration;
  const genLabel = gen === 1 ? '2nd' : gen === 2 ? '3rd' : `${gen + 1}th`;
  log(`<span style="color:var(--neon-cyan)">${genLabel} Time Founder</span> â€” ${getPrestigeMultiplier().toFixed(1)}x permanent income.`);
}
log('Post content. Expand distribution. Hire agents. Reach <span class="log-money">$1T</span> to escape.');

// If player already has escape hash, show option to view it
if (state.nftHash) {
  log(`<span class="log-good">Your escape hash is saved.</span> <span class="log-money" style="cursor:pointer;text-decoration:underline" onclick="showNFTModal('${state.nftHash}')">View hash</span>`);
}
</script>

</body>
</html>
